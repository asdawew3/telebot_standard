<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>控制台 - 浏览器自动化系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/console.css') }}">
    <style>
        /* 全局样式 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 顶部导航栏 */
        .navbar {
            background-color: #1e1e1e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        
        .navbar-brand {
            font-size: 18px;
            font-weight: 500;
            color: #ffffff;
            text-decoration: none;
        }
        
        .navbar-user {
            display: flex;
            align-items: center;
        }
        
        .navbar-username {
            margin-right: 15px;
            color: #aaaaaa;
            font-size: 14px;
        }
        
        .navbar-logout {
            color: #4a6ed3;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .navbar-logout:hover {
            color: #3a5ec3;
        }
        
        /* 主要内容区域 */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* 侧边栏 */
        .sidebar {
            width: 280px;
            background-color: #1a1a1a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #333;
        }
        
        .sidebar-title {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }
        
        .instance-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .instance-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background-color: #252525;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .instance-item:hover {
            background-color: #2a2a2a;
        }
        
        .instance-item.active {
            background-color: #2c3a61;
            border-left: 3px solid #4a6ed3;
        }
        
        .instance-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .instance-id {
            font-size: 12px;
            color: #888888;
        }
        
        .instance-status {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .status-ready {
            color: #4caf50;
        }
        
        .status-error {
            color: #f44336;
        }
        
        .status-initializing {
            color: #ff9800;
        }
        
        .refresh-button {
            padding: 8px 15px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 15px;
            transition: background-color 0.2s;
        }
        
        .refresh-button:hover {
            background-color: #333333;
        }
        
        /* 控制台区域 */
        .console-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .console-header {
            padding: 15px;
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-title {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }
        
        .console-actions {
            display: flex;
            gap: 10px;
        }
        
        .console-button {
            padding: 6px 12px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        
        .console-button:hover {
            background-color: #333333;
        }
        
        .console-button.connect {
            background-color: #2c3a61;
            border-color: #4a6ed3;
        }
        
        .console-button.connect:hover {
            background-color: #3a4c7a;
        }
        
        .console-button.clear {
            background-color: #3a3a3a;
        }
        
        .console-output {
            flex: 1;
            background-color: #0f0f0f;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .console-message {
            margin-bottom: 6px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .message-log {
            color: #e0e0e0;
        }
        
        .message-info {
            color: #64b5f6;
        }
        
        .message-warning {
            color: #ffb74d;
        }
        
        .message-error {
            color: #e57373;
        }
        
        .message-system {
            color: #4db6ac;
        }
        
        .message-timestamp {
            color: #666666;
            margin-right: 8px;
            font-size: 12px;
        }
        
        .console-input-container {
            background-color: #1a1a1a;
            padding: 10px;
            border-top: 1px solid #333;
        }
        
        .console-input-form {
            display: flex;
            gap: 10px;
        }
        
        .console-input {
            flex: 1;
            padding: 10px;
            background-color: #2a2a2a;
            border: 1px solid #333;
            border-radius: 4px;
            color: #ffffff;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            resize: none;
            height: 38px;
            min-height: 38px;
            overflow-y: auto;
            line-height: 1.2;
        }
        
        .console-input:focus {
            outline: none;
            border-color: #4a6ed3;
        }
        
        .console-submit {
            padding: 10px 15px;
            background-color: #4a6ed3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            height: 38px;
        }
        
        .console-submit:hover {
            background-color: #3a5ec3;
        }
        
        /* 空状态提示 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666666;
            text-align: center;
            padding: 20px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .empty-state-title {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .empty-state-text {
            font-size: 14px;
            max-width: 400px;
        }
        
        /* 加载状态 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #4a6ed3;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* URL设置表单 */
        .url-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding: 10px 15px;
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
            align-items: center;
        }
        
        .url-form label {
            font-size: 14px;
            white-space: nowrap;
        }
        
        .url-form input[type="url"] {
            flex: 1;
            padding: 6px 10px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .url-form button {
            padding: 6px 12px;
            background-color: #2c3a61;
            color: #e0e0e0;
            border: 1px solid #4a6ed3;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        .url-form button:hover {
            background-color: #3a4c7a;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="#" class="navbar-brand">Telegram自动化系统</a>
        <div class="navbar-user">
            <span class="navbar-username">用户: <span id="username">{{ session.username }}</span></span>
            <a href="{{ url_for('logout') }}" class="navbar-logout">退出登录</a>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">实例列表</h3>
            </div>
            
            <div class="instance-list" id="instanceList">
                <!-- 实例列表将通过JavaScript动态加载 -->
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            
            <button class="refresh-button" id="refreshButton">刷新实例列表</button>
        </div>
        
        <div class="console-container">
            <div class="console-header">
                <h2 class="console-title">控制台</h2>
                <div class="console-actions">
                    <button id="connectButton" class="console-button connect">连接</button>
                    <button id="disconnectButton" class="console-button disconnect" disabled>断开</button>
                    <button id="clearButton" class="console-button clear">清空</button>
                </div>
            </div>
            
            <!-- 添加URL设置表单 -->
            <div class="url-form">
                <label for="browserUrl">浏览器初始URL:</label>
                <input type="url" id="browserUrl" placeholder="https://example.com" required>
                <button id="setUrlButton">设置URL</button>
            </div>
            
            <div class="console-output" id="consoleOutput">
                <div class="empty-state">
                    <div class="empty-state-icon">🖥️</div>
                    <div class="empty-state-title">控制台未连接</div>
                    <div class="empty-state-text">请从左侧选择一个实例，然后点击"连接控制台"按钮</div>
                </div>
            </div>
            
            <div class="console-input-container">
                <form id="consoleForm" class="console-form">
                    <div class="input-wrapper">
                        <textarea id="consoleInput" class="console-input" placeholder="输入命令..." disabled></textarea>
                    </div>
                    <button type="button" id="submitButton" class="console-button submit" disabled>
                        <i class="icon-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
    <script>
        // 全局变量
        let selectedInstanceId = null;
        let consoleConnected = false;
        let console_instance_id = null;
        let socket = null;
        
        // 添加会话心跳机制，定期刷新令牌
        let sessionHeartbeatInterval;
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化Socket.IO连接
            initSocketIO();
            
            // 加载实例列表
            loadInstances();
            
            // 初始化事件处理
            initEventHandlers();
            
            // 启动心跳
            startSessionHeartbeat();
            
            // 用户活动时也刷新令牌
            const userActivityEvents = ['mousedown', 'keydown', 'touchstart', 'scroll'];
            let lastActivityTime = Date.now();
            
            // 监听用户活动事件
            userActivityEvents.forEach(eventType => {
                document.addEventListener(eventType, function() {
                    const now = Date.now();
                    // 至少间隔5分钟才触发一次令牌刷新
                    if (now - lastActivityTime > 300000) {
                        lastActivityTime = now;
                        // 发送验证请求刷新令牌
                        fetch('/api/verify-token', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache'
                            },
                            credentials: 'same-origin'
                        }).then(response => response.json())
                          .then(data => console.log("用户活动触发令牌刷新:", data.success))
                          .catch(error => console.error("令牌刷新失败:", error));
                    }
                });
            });
        });
        
        // 初始化Socket.IO连接
        function initSocketIO() {
            // 创建Socket.IO连接
            socket = io();
            
            // 连接事件
            socket.on('connect', function() {
                console.log('Socket.IO连接成功');
            });
            
            // 连接错误
            socket.on('connect_error', function(err) {
                console.error('Socket.IO连接错误:', err);
            });
            
            // 重新连接尝试
            socket.io.on('reconnect_attempt', function(attempt) {
                console.warn('Socket.IO重新连接尝试，第', attempt, '次');
            });
            
            // 重新连接成功
            socket.io.on('reconnect', function(attempt) {
                console.log('Socket.IO重新连接成功，尝试次数:', attempt);
            });
            
            // 断开连接事件
            socket.on('disconnect', function(reason) {
                console.log('Socket.IO连接断开，原因:', reason);
            });
            
            // 控制台输出事件
            socket.on('console_output', function(data) {
                console.log('收到控制台输出', data);
                console.log(`收到 ${data.messages ? data.messages.length : 0} 条消息，时间戳: ${data.timestamp || 'none'}`);
                
                if (data.messages && Array.isArray(data.messages)) {
                    // 记录消息类型统计
                    const typeCounts = {};
                    data.messages.forEach(msg => {
                        const type = msg.type || 'unknown';
                        typeCounts[type] = (typeCounts[type] || 0) + 1;
                    });
                    console.log('消息类型统计:', typeCounts);
                    
                    // 获取控制台输出元素
                    const consoleOutput = document.getElementById('consoleOutput');
                    
                    // 检查控制台消息数量，如果超过2000条，则清理旧消息
                    const currentMessages = consoleOutput.querySelectorAll('.console-message');
                    if (currentMessages.length > 2000) {
                        console.log(`当前控制台消息数量(${currentMessages.length})超过2000条，清理旧消息`);
                        
                        // 计算需要删除的消息数量（保留最新的1800条）
                        const removeCount = currentMessages.length - 1800;
                        
                        // 删除旧消息
                        for (let i = 0; i < removeCount; i++) {
                            if (consoleOutput.firstChild) {
                                consoleOutput.removeChild(consoleOutput.firstChild);
                            }
                        }
                        
                        // 添加一条系统消息，告知用户旧消息已被清理
                        const cleanupMessage = document.createElement('div');
                        cleanupMessage.className = 'console-message message-system';
                        cleanupMessage.textContent = `已自动清理 ${removeCount} 条旧消息以优化性能`;
                        consoleOutput.appendChild(cleanupMessage);
                        
                        console.log(`已删除 ${removeCount} 条旧消息，当前消息数量: ${consoleOutput.querySelectorAll('.console-message').length}`);
                    }
                    
                    // 处理每条消息
                    data.messages.forEach((message, index) => {
                        console.log(`处理第 ${index+1}/${data.messages.length} 条消息:`, 
                            message.type, message.level, message.content ? message.content.substring(0, 50) : 'empty');
                        appendConsoleMessage(message);
                    });
                    
                    console.log('所有消息处理完成');
                    
                    // 确保滚动到底部，使用平滑滚动效果
                    consoleOutput.scrollTo({
                        top: consoleOutput.scrollHeight,
                        behavior: 'smooth'
                    });
                } else {
                    console.warn('收到无效的控制台输出数据', data);
                }
            });
            
            // 系统消息事件
            socket.on('system', function(data) {
                console.log('收到系统消息', data);
                appendSystemMessage(data.type, data.message);
            });
            
            // 控制台状态事件
            socket.on('console_status', function(data) {
                console.log('收到控制台状态', data);
                
                // 更新全局状态
                consoleConnected = data.connected;
                console_instance_id = data.instance_id;
                
                // 更新UI
                updateButtonState();
                
                // 如果已连接，显示实例ID
                if (data.connected && data.instance_id) {
                    // 不再检查控制台是否为空，避免清空现有消息
                    // const consoleOutput = document.getElementById('consoleOutput');
                    // if (!consoleOutput.childNodes.length) {
                    //     appendSystemMessage('info', `已连接到实例: ${data.instance_id}`);
                    // }
                }
            });
        }
        
        // 加载实例列表
        function loadInstances() {
            const instanceList = document.getElementById('instanceList');
            instanceList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            fetch('/api/instances')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderInstanceList(data.instances);
                    } else {
                        instanceList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-title">加载失败</div>
                                <div class="empty-state-text">${data.message || '无法加载实例列表'}</div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('加载实例列表失败:', error);
                    instanceList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-title">加载失败</div>
                            <div class="empty-state-text">网络错误，请稍后重试</div>
                        </div>
                    `;
                });
        }
        
        // 渲染实例列表
        function renderInstanceList(instances) {
            const instanceList = document.getElementById('instanceList');
            
            if (!instances || instances.length === 0) {
                instanceList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-title">暂无实例</div>
                        <div class="empty-state-text">当前没有可用的实例</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            instances.forEach(instance => {
                const isActive = selectedInstanceId === instance.id;
                const statusClass = getStatusClass(instance.status);
                
                html += `
                    <div class="instance-item ${isActive ? 'active' : ''}" data-id="${instance.id}">
                        <div class="instance-name">${instance.name}</div>
                        <div class="instance-id">${instance.id}</div>
                        <div class="instance-status ${statusClass}">
                            状态: ${getStatusText(instance.status)}
                        </div>
                    </div>
                `;
            });
            
            instanceList.innerHTML = html;
            
            // 绑定实例点击事件
            const instanceItems = document.querySelectorAll('.instance-item');
            instanceItems.forEach(item => {
                item.addEventListener('click', function() {
                    const instanceId = this.getAttribute('data-id');
                    selectInstance(instanceId);
                });
            });
            
            // 如果之前选择的实例不在列表中，清除选择
            if (selectedInstanceId) {
                const exists = instances.some(instance => instance.id === selectedInstanceId);
                if (!exists) {
                    selectInstance(null);
                }
            }
        }
        
        // 选择实例
        function selectInstance(instanceId) {
            // 更新选中状态
            const instanceItems = document.querySelectorAll('.instance-item');
            instanceItems.forEach(item => {
                const itemId = item.getAttribute('data-id');
                if (itemId === instanceId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // 更新选中的实例ID
            selectedInstanceId = instanceId;
            
            // 更新控制台标题
            updateConsoleTitle();
            
            // 更新按钮状态
            updateButtonState();
            
            // 如果控制台已连接到其他实例，断开连接
            if (consoleConnected && selectedInstanceId && console_instance_id !== selectedInstanceId) {
                disconnectConsole();
            }
        }
        
        // 更新控制台标题
        function updateConsoleTitle() {
            const consoleTitle = document.getElementById('consoleTitle');
            if (selectedInstanceId) {
                const selectedInstance = document.querySelector(`.instance-item[data-id="${selectedInstanceId}"]`);
                if (selectedInstance) {
                    const instanceName = selectedInstance.querySelector('.instance-name').textContent;
                    consoleTitle.textContent = `控制台 - ${instanceName}`;
                } else {
                    consoleTitle.textContent = `控制台 - ${selectedInstanceId}`;
                }
            } else {
                consoleTitle.textContent = '控制台';
            }
        }
        
        // 更新按钮状态
        function updateButtonState() {
            const connectButton = document.getElementById('connectButton');
            const clearButton = document.getElementById('clearButton');
            const consoleInput = document.getElementById('consoleInput');
            const submitButton = document.getElementById('submitButton');
            
            if (selectedInstanceId) {
                connectButton.disabled = false;
                connectButton.textContent = consoleConnected ? '断开控制台' : '连接控制台';
                clearButton.disabled = !consoleConnected;
                consoleInput.disabled = !consoleConnected;
                submitButton.disabled = !consoleConnected;
            } else {
                connectButton.disabled = true;
                clearButton.disabled = true;
                consoleInput.disabled = true;
                submitButton.disabled = true;
                connectButton.textContent = '连接控制台';
            }
            
            // 确保输入框可以接收输入
            if (!consoleInput.disabled) {
                consoleInput.focus();
            }
        }
        
        // 切换控制台连接状态
        function toggleConsoleConnection() {
            if (!selectedInstanceId) return;
            
            if (consoleConnected) {
                disconnectConsole();
            } else {
                connectConsole();
            }
        }
        
        // 连接控制台
        function connectConsole() {
            if (!selectedInstanceId) return;
            
            // 显示加载状态，但不清空现有消息
            const consoleOutput = document.getElementById('consoleOutput');
            // 添加一个加载指示器，而不是替换整个内容
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading';
            loadingIndicator.innerHTML = '<div class="loading-spinner"></div><div class="loading-text">正在连接控制台...</div>';
            loadingIndicator.style.position = 'absolute';
            loadingIndicator.style.top = '50%';
            loadingIndicator.style.left = '50%';
            loadingIndicator.style.transform = 'translate(-50%, -50%)';
            loadingIndicator.style.padding = '20px';
            loadingIndicator.style.borderRadius = '5px';
            loadingIndicator.style.zIndex = '1000';
            loadingIndicator.id = 'loadingIndicator';
            
            // 如果已经有加载指示器，先移除
            const existingIndicator = document.getElementById('loadingIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // 添加加载指示器
            consoleOutput.appendChild(loadingIndicator);
            
            // 发送连接请求
            fetch('/api/console/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    instance_id: selectedInstanceId
                })
            })
            .then(response => response.json())
            .then(data => {
                // 移除加载指示器
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                if (data.success) {
                    // 连接成功，更新状态
                    consoleConnected = true;
                    console_instance_id = selectedInstanceId;
                    
                    // 更新按钮状态
                    updateButtonState();
                    
                    // 不清空控制台，保留现有消息
                    // document.getElementById('consoleOutput').innerHTML = '';
                    
                    // 显示连接成功消息
                    appendSystemMessage('success', `已连接到实例: ${selectedInstanceId}`);
                    appendSystemMessage('info', '控制台已准备就绪，可以执行JavaScript命令');
                    
                    // 聚焦输入框
                    setTimeout(() => {
                        const consoleInput = document.getElementById('consoleInput');
                        if (consoleInput) {
                            consoleInput.disabled = false;
                            consoleInput.focus();
                        }
                    }, 100);
                } else {
                    // 连接失败，显示错误消息，但不清空现有消息
                    appendSystemMessage('error', `连接失败: ${data.message || '未知错误'}`);
                }
            })
            .catch(error => {
                // 移除加载指示器
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                console.error('连接控制台失败:', error);
                appendSystemMessage('error', `连接失败: ${error.message || '网络错误'}`);
            });
        }
        
        // 断开控制台连接
        function disconnectConsole() {
            fetch('/api/console/disconnect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    appendSystemMessage('error', `断开连接失败: ${data.message || '未知错误'}`);
                }
            })
            .catch(error => {
                console.error('断开控制台连接失败:', error);
                appendSystemMessage('error', '断开连接失败: 网络错误');
            });
        }
        
        // 清空控制台
        function clearConsole() {
            if (!consoleConnected) return;
            
            fetch('/api/console/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('consoleOutput').innerHTML = '';
                    appendSystemMessage('info', '控制台已清空');
                } else {
                    appendSystemMessage('error', `清空控制台失败: ${data.message || '未知错误'}`);
                }
            })
            .catch(error => {
                console.error('清空控制台失败:', error);
                appendSystemMessage('error', '清空控制台失败: 网络错误');
            });
        }
        
        // 发送命令
        function sendCommand() {
            const consoleInput = document.getElementById('consoleInput');
            const command = consoleInput.value.trim();
            
            if (!command) return;
            
            // 禁用输入框，防止重复提交
            consoleInput.disabled = true;
            document.getElementById('submitButton').disabled = true;
            
            console.log('准备发送命令:', command);
            
            // 通过WebSocket发送命令（添加此部分）
            if (socket && socket.connected) {
                console.log('使用WebSocket发送命令');
                socket.emit('console_command', {
                    command: command,
                    timestamp: Date.now()
                });
                
                // 清空输入框
                consoleInput.value = '';
                consoleInput.style.height = '38px'; // 重置高度
                
                // 重新启用输入框
                consoleInput.disabled = false;
                document.getElementById('submitButton').disabled = false;
                consoleInput.focus();
                
                console.log('WebSocket命令已发送');
                return; // 使用WebSocket发送后直接返回，不再使用HTTP请求
            }
            
            console.log('WebSocket不可用，使用HTTP请求发送命令');
            
            // 如果WebSocket不可用，则使用HTTP请求（保留原有代码作为备用）
            fetch('/api/console/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: command
                })
            })
            .then(response => response.json())
            .then(data => {
                // 清空输入框
                consoleInput.value = '';
                consoleInput.style.height = '38px'; // 重置高度
                
                // 重新启用输入框
                consoleInput.disabled = false;
                document.getElementById('submitButton').disabled = false;
                consoleInput.focus();
                
                // 如果执行失败，显示错误消息
                if (!data.success) {
                    appendSystemMessage('error', `命令执行失败: ${data.message || '未知错误'}`);
                }
            })
            .catch(error => {
                console.error('执行命令失败:', error);
                
                // 重新启用输入框
                consoleInput.disabled = false;
                document.getElementById('submitButton').disabled = false;
                consoleInput.focus();
                
                // 显示错误消息
                appendSystemMessage('error', `命令执行失败: ${error.message || '网络错误'}`);
            });
        }
        
        // 添加控制台消息
        function appendConsoleMessage(message) {
            const consoleOutput = document.getElementById('consoleOutput');
            
            // 调试日志
            console.log('添加控制台消息:', message);
            
            // 创建消息元素
            const messageElement = document.createElement('div');
            messageElement.className = `console-message message-${message.level || 'log'}`;
            
            // 创建时间戳
            const timestamp = new Date(message.timestamp).toLocaleTimeString();
            const timestampElement = document.createElement('span');
            timestampElement.className = 'message-timestamp';
            timestampElement.textContent = timestamp;
            
            // 添加时间戳
            messageElement.appendChild(timestampElement);
            
            // 处理消息内容
            let content = message.content || '';
            
            // 根据消息类型设置内容
            if (message.type === 'input') {
                // 命令输入
                messageElement.className = 'console-message message-input';
                
                // 创建命令前缀
                const prefixSpan = document.createElement('span');
                prefixSpan.className = 'command-prefix';
                prefixSpan.textContent = '> ';
                messageElement.appendChild(prefixSpan);
                
                // 添加命令内容
                messageElement.appendChild(document.createTextNode(content));
                console.log('添加输入消息:', content);
            } else if (message.type === 'system') {
                // 系统消息
                messageElement.className = `console-message message-system`;
                messageElement.appendChild(document.createTextNode(content));
                console.log('添加系统消息:', content);
            } else if (message.type === 'error') {
                // 错误消息
                messageElement.className = 'console-message message-error';
                
                // 创建错误前缀
                const errorPrefix = document.createElement('span');
                errorPrefix.className = 'error-prefix';
                errorPrefix.textContent = 'Error: ';
                messageElement.appendChild(errorPrefix);
                
                // 添加错误内容
                messageElement.appendChild(document.createTextNode(content));
                console.log('添加错误消息:', content);
            } else if (message.type === 'result') {
                // 结果消息
                messageElement.className = 'console-message message-result';
                
                // 检查是否是JSON字符串，如果是则格式化显示
                try {
                    if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
                        const jsonObj = JSON.parse(content);
                        content = JSON.stringify(jsonObj, null, 2);
                        
                        // 使用pre标签保留格式
                        const preElement = document.createElement('pre');
                        preElement.className = 'json-content';
                        preElement.textContent = content;
                        messageElement.appendChild(preElement);
                        console.log('添加格式化JSON结果消息');
                        return messageElement;
                    }
                } catch (e) {
                    // 不是有效的JSON，继续使用普通文本
                    console.log('结果不是有效JSON，使用普通文本显示');
                }
                
                messageElement.appendChild(document.createTextNode(content));
                console.log('添加结果消息:', content.substring(0, 100) + (content.length > 100 ? '...' : ''));
            } else {
                // 普通控制台消息
                
                // 检查是否是多行文本
                if (content.includes('\n')) {
                    // 使用pre标签保留格式
                    const preElement = document.createElement('pre');
                    preElement.className = 'multiline-content';
                    preElement.textContent = content;
                    messageElement.appendChild(preElement);
                    console.log('添加多行消息');
                } else {
                    messageElement.appendChild(document.createTextNode(content));
                    console.log('添加普通消息:', content.substring(0, 100) + (content.length > 100 ? '...' : ''));
                }
            }
            
            // 添加到控制台
            consoleOutput.appendChild(messageElement);
            console.log('消息元素已添加到DOM');
            
            // 滚动到底部
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console.log('控制台已滚动到底部');
            
            // 返回添加的元素，方便调试
            return messageElement;
        }
        
        // 添加系统消息
        function appendSystemMessage(level, message) {
            const consoleOutput = document.getElementById('consoleOutput');
            
            // 创建消息元素
            const messageElement = document.createElement('div');
            messageElement.className = `console-message message-${level}`;
            
            // 创建时间戳
            const timestamp = new Date().toLocaleTimeString();
            const timestampElement = document.createElement('span');
            timestampElement.className = 'message-timestamp';
            timestampElement.textContent = timestamp;
            
            // 添加时间戳和消息
            messageElement.appendChild(timestampElement);
            messageElement.appendChild(document.createTextNode(message));
            
            // 添加到控制台
            consoleOutput.appendChild(messageElement);
            
            // 滚动到底部
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // 获取状态样式类
        function getStatusClass(status) {
            switch (status) {
                case 'ready':
                    return 'status-ready';
                case 'error':
                    return 'status-error';
                case 'initializing':
                    return 'status-initializing';
                default:
                    return '';
            }
        }
        
        // 获取状态文本
        function getStatusText(status) {
            switch (status) {
                case 'ready':
                    return '就绪';
                case 'error':
                    return '错误';
                case 'initializing':
                    return '初始化中';
                case 'created':
                    return '已创建';
                case 'terminated':
                    return '已终止';
                default:
                    return status;
            }
        }
        
        // 获取消息样式类
        function getMessageClass(type, level) {
            if (type === 'system') {
                return 'message-system';
            }
            
            switch (level) {
                case 'info':
                    return 'message-info';
                case 'warning':
                    return 'message-warning';
                case 'error':
                    return 'message-error';
                default:
                    return 'message-log';
            }
        }
        
        // 启动心跳
        function startSessionHeartbeat() {
            // 清除可能存在的旧心跳
            if (sessionHeartbeatInterval) {
                clearInterval(sessionHeartbeatInterval);
            }
            
            // 设置心跳间隔为15分钟（900000毫秒）
            // 这个值应小于服务器端验证间隔（30分钟）
            sessionHeartbeatInterval = setInterval(async function() {
                console.log("执行会话心跳...");
                try {
                    // 发送令牌验证请求
                    const response = await fetch('/api/verify-token', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log("会话心跳成功，令牌有效");
                    } else {
                        console.warn("会话心跳失败，令牌可能已失效:", result.message);
                        // 如果令牌验证失败，重定向到登录页面
                        if (result.error_code === 'TOKEN_EXPIRED' || result.error_code === 'NOT_AUTHENTICATED') {
                            window.location.href = '/login';
                        }
                    }
                } catch (error) {
                    console.error("会话心跳请求异常:", error);
                    // 网络错误不做处理，等待下次心跳
                }
            }, 900000); // 15分钟
            
            console.log("会话心跳机制已启动");
        }
        
        // 初始化事件处理
        function initEventHandlers() {
            console.log('初始化事件处理器');
            
            // 连接按钮点击事件
            document.getElementById('connectButton').addEventListener('click', toggleConsoleConnection);
            
            // 清空按钮点击事件
            document.getElementById('clearButton').addEventListener('click', clearConsole);
            
            // 提交按钮点击事件
            document.getElementById('submitButton').addEventListener('click', sendCommand);
            
            // 刷新按钮点击事件
            document.getElementById('refreshButton').addEventListener('click', function() {
                console.log('刷新实例列表');
                loadInstances();
            });
            
            // 表单提交事件（防止刷新页面）
            document.getElementById('consoleForm').addEventListener('submit', function(event) {
                console.log('捕获consoleForm提交事件，阻止默认刷新');
                event.preventDefault();
                sendCommand();
            });
            
            // 输入框Enter键事件
            const consoleInput = document.getElementById('consoleInput');
            consoleInput.addEventListener('keydown', function(event) {
                // 检查是否按下了Enter键且没有按下Shift键（Shift+Enter用于换行）
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); // 阻止默认行为（换行）
                    sendCommand(); // 发送命令
                }
            });
            
            // 输入框自动调整高度
            consoleInput.addEventListener('input', function() {
                this.style.height = '38px'; // 重置高度
                this.style.height = (this.scrollHeight) + 'px'; // 设置新高度
            });
            
            // 实例列表点击事件
            document.getElementById('instanceList').addEventListener('click', function(e) {
                const instanceItem = e.target.closest('.instance-item');
                if (instanceItem) {
                    const instanceId = instanceItem.getAttribute('data-id');
                    selectInstance(instanceId);
                }
            });
            
            console.log('事件处理器初始化完成');
        }

        // 获取当前浏览器URL设置
        function getCurrentBrowserUrl() {
            fetch('/api/config/browser-url')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('browserUrl').value = data.url;
                    } else {
                        console.error('获取浏览器URL失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('获取浏览器URL请求失败:', error);
                });
        }
        
        // 设置浏览器URL
        document.getElementById('setUrlButton').addEventListener('click', function() {
            const url = document.getElementById('browserUrl').value;
            if (!url) {
                alert('请输入有效的URL');
                return;
            }
            
            fetch('/api/config/browser-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('浏览器初始URL已更新');
                } else {
                    alert('更新失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('设置URL请求失败:', error);
                alert('请求失败，请检查网络连接');
            });
        });
        
        // 页面加载时获取当前URL
        document.addEventListener('DOMContentLoaded', function() {
            getCurrentBrowserUrl();
        });
    </script>
</body>
</html>