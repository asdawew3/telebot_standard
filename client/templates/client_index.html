<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§åˆ¶å° - Telegramè‡ªåŠ¨åŒ–ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/console.css') }}">
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background-color: #1e1e1e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        
        .navbar-brand {
            font-size: 18px;
            font-weight: 500;
            color: #ffffff;
            text-decoration: none;
        }
        
        .navbar-user {
            display: flex;
            align-items: center;
        }
        
        .navbar-username {
            margin-right: 15px;
            color: #aaaaaa;
            font-size: 14px;
        }
        
        .navbar-logout {
            color: #4a6ed3;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .navbar-logout:hover {
            color: #3a5ec3;
        }
        
        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background-color: #1a1a1a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #333;
        }
        
        .sidebar-title {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }
        
        .instance-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .instance-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background-color: #252525;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .instance-item:hover {
            background-color: #2a2a2a;
        }
        
        .instance-item.active {
            background-color: #2c3a61;
            border-left: 3px solid #4a6ed3;
        }
        
        .instance-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .instance-id {
            font-size: 12px;
            color: #888888;
        }
        
        .instance-status {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .status-ready {
            color: #4caf50;
        }
        
        .status-error {
            color: #f44336;
        }
        
        .status-initializing {
            color: #ff9800;
        }
        
        .refresh-button {
            padding: 8px 15px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 15px;
            transition: background-color 0.2s;
        }
        
        .refresh-button:hover {
            background-color: #333333;
        }
        
        /* æ§åˆ¶å°åŒºåŸŸ */
        .console-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .console-header {
            padding: 15px;
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-title {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }
        
        .console-actions {
            display: flex;
            gap: 10px;
        }
        
        .console-button {
            padding: 6px 12px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        
        .console-button:hover {
            background-color: #333333;
        }
        
        .console-button.connect {
            background-color: #2c3a61;
            border-color: #4a6ed3;
        }
        
        .console-button.connect:hover {
            background-color: #3a4c7a;
        }
        
        .console-button.clear {
            background-color: #3a3a3a;
        }
        
        .console-output {
            flex: 1;
            background-color: #0f0f0f;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .console-message {
            margin-bottom: 6px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .message-log {
            color: #e0e0e0;
        }
        
        .message-info {
            color: #64b5f6;
        }
        
        .message-warning {
            color: #ffb74d;
        }
        
        .message-error {
            color: #e57373;
        }
        
        .message-system {
            color: #4db6ac;
        }
        
        .message-timestamp {
            color: #666666;
            margin-right: 8px;
            font-size: 12px;
        }
        
        .console-input-container {
            background-color: #1a1a1a;
            padding: 10px;
            border-top: 1px solid #333;
        }
        
        .console-input-form {
            display: flex;
            gap: 10px;
        }
        
        .console-input {
            flex: 1;
            padding: 10px;
            background-color: #2a2a2a;
            border: 1px solid #333;
            border-radius: 4px;
            color: #ffffff;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            resize: none;
            height: 38px;
            min-height: 38px;
            overflow-y: auto;
            line-height: 1.2;
        }
        
        .console-input:focus {
            outline: none;
            border-color: #4a6ed3;
        }
        
        .console-submit {
            padding: 10px 15px;
            background-color: #4a6ed3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            height: 38px;
        }
        
        .console-submit:hover {
            background-color: #3a5ec3;
        }
        
        /* ç©ºçŠ¶æ€æç¤º */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666666;
            text-align: center;
            padding: 20px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .empty-state-title {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .empty-state-text {
            font-size: 14px;
            max-width: 400px;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #4a6ed3;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="#" class="navbar-brand">Telegramè‡ªåŠ¨åŒ–ç³»ç»Ÿ</a>
        <div class="navbar-user">
            <span class="navbar-username">ç”¨æˆ·: <span id="username">{{ session.username }}</span></span>
            <a href="{{ url_for('logout') }}" class="navbar-logout">é€€å‡ºç™»å½•</a>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">å®ä¾‹åˆ—è¡¨</h3>
            </div>
            
            <div class="instance-list" id="instanceList">
                <!-- å®ä¾‹åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            
            <button class="refresh-button" id="refreshButton">åˆ·æ–°å®ä¾‹åˆ—è¡¨</button>
        </div>
        
        <div class="console-container">
            <div class="console-header">
                <h3 class="console-title" id="consoleTitle">æ§åˆ¶å°</h3>
                <div class="console-actions">
                    <button class="console-button connect" id="connectButton" disabled>è¿æ¥æ§åˆ¶å°</button>
                    <button class="console-button clear" id="clearButton" disabled>æ¸…ç©ºæ§åˆ¶å°</button>
                </div>
            </div>
            
            <div class="console-output" id="consoleOutput">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ–¥ï¸</div>
                    <div class="empty-state-title">æ§åˆ¶å°æœªè¿æ¥</div>
                    <div class="empty-state-text">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå®ä¾‹ï¼Œç„¶åç‚¹å‡»"è¿æ¥æ§åˆ¶å°"æŒ‰é’®</div>
                </div>
            </div>
            
            <div class="console-input-container">
                <form id="consoleForm" class="console-form">
                    <div class="input-wrapper">
                        <textarea id="consoleInput" class="console-input" placeholder="è¾“å…¥å‘½ä»¤..." disabled></textarea>
                    </div>
                    <button type="button" id="submitButton" class="console-button submit" disabled>
                        <i class="icon-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let selectedInstanceId = null;
        let consoleConnected = false;
        let console_instance_id = null;
        let socket = null;
        
        // æ·»åŠ ä¼šè¯å¿ƒè·³æœºåˆ¶ï¼Œå®šæœŸåˆ·æ–°ä»¤ç‰Œ
        let sessionHeartbeatInterval;
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–Socket.IOè¿æ¥
            initSocketIO();
            
            // åŠ è½½å®ä¾‹åˆ—è¡¨
            loadInstances();
            
            // åˆå§‹åŒ–äº‹ä»¶å¤„ç†
            initEventHandlers();
            
            // å¯åŠ¨å¿ƒè·³
            startSessionHeartbeat();
            
            // ç”¨æˆ·æ´»åŠ¨æ—¶ä¹Ÿåˆ·æ–°ä»¤ç‰Œ
            const userActivityEvents = ['mousedown', 'keydown', 'touchstart', 'scroll'];
            let lastActivityTime = Date.now();
            
            // ç›‘å¬ç”¨æˆ·æ´»åŠ¨äº‹ä»¶
            userActivityEvents.forEach(eventType => {
                document.addEventListener(eventType, function() {
                    const now = Date.now();
                    // è‡³å°‘é—´éš”5åˆ†é’Ÿæ‰è§¦å‘ä¸€æ¬¡ä»¤ç‰Œåˆ·æ–°
                    if (now - lastActivityTime > 300000) {
                        lastActivityTime = now;
                        // å‘é€éªŒè¯è¯·æ±‚åˆ·æ–°ä»¤ç‰Œ
                        fetch('/api/verify-token', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache'
                            },
                            credentials: 'same-origin'
                        }).then(response => response.json())
                          .then(data => console.log("ç”¨æˆ·æ´»åŠ¨è§¦å‘ä»¤ç‰Œåˆ·æ–°:", data.success))
                          .catch(error => console.error("ä»¤ç‰Œåˆ·æ–°å¤±è´¥:", error));
                    }
                });
            });
        });
        
        // åˆå§‹åŒ–Socket.IOè¿æ¥
        function initSocketIO() {
            // åˆ›å»ºSocket.IOè¿æ¥
            socket = io();
            
            // è¿æ¥äº‹ä»¶
            socket.on('connect', function() {
                console.log('Socket.IOè¿æ¥æˆåŠŸ');
            });
            
            // è¿æ¥é”™è¯¯
            socket.on('connect_error', function(err) {
                console.error('Socket.IOè¿æ¥é”™è¯¯:', err);
            });
            
            // é‡æ–°è¿æ¥å°è¯•
            socket.io.on('reconnect_attempt', function(attempt) {
                console.warn('Socket.IOé‡æ–°è¿æ¥å°è¯•ï¼Œç¬¬', attempt, 'æ¬¡');
            });
            
            // é‡æ–°è¿æ¥æˆåŠŸ
            socket.io.on('reconnect', function(attempt) {
                console.log('Socket.IOé‡æ–°è¿æ¥æˆåŠŸï¼Œå°è¯•æ¬¡æ•°:', attempt);
            });
            
            // æ–­å¼€è¿æ¥äº‹ä»¶
            socket.on('disconnect', function(reason) {
                console.log('Socket.IOè¿æ¥æ–­å¼€ï¼ŒåŸå› :', reason);
            });
            
            // æ§åˆ¶å°è¾“å‡ºäº‹ä»¶
            socket.on('console_output', function(data) {
                console.log('æ”¶åˆ°æ§åˆ¶å°è¾“å‡º', data);
                console.log(`æ”¶åˆ° ${data.messages ? data.messages.length : 0} æ¡æ¶ˆæ¯ï¼Œæ—¶é—´æˆ³: ${data.timestamp || 'none'}`);
                
                if (data.messages && Array.isArray(data.messages)) {
                    // è®°å½•æ¶ˆæ¯ç±»å‹ç»Ÿè®¡
                    const typeCounts = {};
                    data.messages.forEach(msg => {
                        const type = msg.type || 'unknown';
                        typeCounts[type] = (typeCounts[type] || 0) + 1;
                    });
                    console.log('æ¶ˆæ¯ç±»å‹ç»Ÿè®¡:', typeCounts);
                    
                    // è·å–æ§åˆ¶å°è¾“å‡ºå…ƒç´ 
                    const consoleOutput = document.getElementById('consoleOutput');
                    
                    // æ£€æŸ¥æ§åˆ¶å°æ¶ˆæ¯æ•°é‡ï¼Œå¦‚æœè¶…è¿‡2000æ¡ï¼Œåˆ™æ¸…ç†æ—§æ¶ˆæ¯
                    const currentMessages = consoleOutput.querySelectorAll('.console-message');
                    if (currentMessages.length > 2000) {
                        console.log(`å½“å‰æ§åˆ¶å°æ¶ˆæ¯æ•°é‡(${currentMessages.length})è¶…è¿‡2000æ¡ï¼Œæ¸…ç†æ—§æ¶ˆæ¯`);
                        
                        // è®¡ç®—éœ€è¦åˆ é™¤çš„æ¶ˆæ¯æ•°é‡ï¼ˆä¿ç•™æœ€æ–°çš„1800æ¡ï¼‰
                        const removeCount = currentMessages.length - 1800;
                        
                        // åˆ é™¤æ—§æ¶ˆæ¯
                        for (let i = 0; i < removeCount; i++) {
                            if (consoleOutput.firstChild) {
                                consoleOutput.removeChild(consoleOutput.firstChild);
                            }
                        }
                        
                        // æ·»åŠ ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥ç”¨æˆ·æ—§æ¶ˆæ¯å·²è¢«æ¸…ç†
                        const cleanupMessage = document.createElement('div');
                        cleanupMessage.className = 'console-message message-system';
                        cleanupMessage.textContent = `å·²è‡ªåŠ¨æ¸…ç† ${removeCount} æ¡æ—§æ¶ˆæ¯ä»¥ä¼˜åŒ–æ€§èƒ½`;
                        consoleOutput.appendChild(cleanupMessage);
                        
                        console.log(`å·²åˆ é™¤ ${removeCount} æ¡æ—§æ¶ˆæ¯ï¼Œå½“å‰æ¶ˆæ¯æ•°é‡: ${consoleOutput.querySelectorAll('.console-message').length}`);
                    }
                    
                    // å¤„ç†æ¯æ¡æ¶ˆæ¯
                    data.messages.forEach((message, index) => {
                        console.log(`å¤„ç†ç¬¬ ${index+1}/${data.messages.length} æ¡æ¶ˆæ¯:`, 
                            message.type, message.level, message.content ? message.content.substring(0, 50) : 'empty');
                        appendConsoleMessage(message);
                    });
                    
                    console.log('æ‰€æœ‰æ¶ˆæ¯å¤„ç†å®Œæˆ');
                    
                    // ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œä½¿ç”¨å¹³æ»‘æ»šåŠ¨æ•ˆæœ
                    consoleOutput.scrollTo({
                        top: consoleOutput.scrollHeight,
                        behavior: 'smooth'
                    });
                } else {
                    console.warn('æ”¶åˆ°æ— æ•ˆçš„æ§åˆ¶å°è¾“å‡ºæ•°æ®', data);
                }
            });
            
            // ç³»ç»Ÿæ¶ˆæ¯äº‹ä»¶
            socket.on('system', function(data) {
                console.log('æ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯', data);
                appendSystemMessage(data.type, data.message);
            });
            
            // æ§åˆ¶å°çŠ¶æ€äº‹ä»¶
            socket.on('console_status', function(data) {
                console.log('æ”¶åˆ°æ§åˆ¶å°çŠ¶æ€', data);
                
                // æ›´æ–°å…¨å±€çŠ¶æ€
                consoleConnected = data.connected;
                console_instance_id = data.instance_id;
                
                // æ›´æ–°UI
                updateButtonState();
                
                // å¦‚æœå·²è¿æ¥ï¼Œæ˜¾ç¤ºå®ä¾‹ID
                if (data.connected && data.instance_id) {
                    // ä¸å†æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦ä¸ºç©ºï¼Œé¿å…æ¸…ç©ºç°æœ‰æ¶ˆæ¯
                    // const consoleOutput = document.getElementById('consoleOutput');
                    // if (!consoleOutput.childNodes.length) {
                    //     appendSystemMessage('info', `å·²è¿æ¥åˆ°å®ä¾‹: ${data.instance_id}`);
                    // }
                }
            });
        }
        
        // åŠ è½½å®ä¾‹åˆ—è¡¨
        function loadInstances() {
            const instanceList = document.getElementById('instanceList');
            instanceList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            fetch('/api/instances')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderInstanceList(data.instances);
                    } else {
                        instanceList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-title">åŠ è½½å¤±è´¥</div>
                                <div class="empty-state-text">${data.message || 'æ— æ³•åŠ è½½å®ä¾‹åˆ—è¡¨'}</div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å®ä¾‹åˆ—è¡¨å¤±è´¥:', error);
                    instanceList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-title">åŠ è½½å¤±è´¥</div>
                            <div class="empty-state-text">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</div>
                        </div>
                    `;
                });
        }
        
        // æ¸²æŸ“å®ä¾‹åˆ—è¡¨
        function renderInstanceList(instances) {
            const instanceList = document.getElementById('instanceList');
            
            if (!instances || instances.length === 0) {
                instanceList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-title">æš‚æ— å®ä¾‹</div>
                        <div class="empty-state-text">å½“å‰æ²¡æœ‰å¯ç”¨çš„å®ä¾‹</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            instances.forEach(instance => {
                const isActive = selectedInstanceId === instance.id;
                const statusClass = getStatusClass(instance.status);
                
                html += `
                    <div class="instance-item ${isActive ? 'active' : ''}" data-id="${instance.id}">
                        <div class="instance-name">${instance.name}</div>
                        <div class="instance-id">${instance.id}</div>
                        <div class="instance-status ${statusClass}">
                            çŠ¶æ€: ${getStatusText(instance.status)}
                        </div>
                    </div>
                `;
            });
            
            instanceList.innerHTML = html;
            
            // ç»‘å®šå®ä¾‹ç‚¹å‡»äº‹ä»¶
            const instanceItems = document.querySelectorAll('.instance-item');
            instanceItems.forEach(item => {
                item.addEventListener('click', function() {
                    const instanceId = this.getAttribute('data-id');
                    selectInstance(instanceId);
                });
            });
            
            // å¦‚æœä¹‹å‰é€‰æ‹©çš„å®ä¾‹ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œæ¸…é™¤é€‰æ‹©
            if (selectedInstanceId) {
                const exists = instances.some(instance => instance.id === selectedInstanceId);
                if (!exists) {
                    selectInstance(null);
                }
            }
        }
        
        // é€‰æ‹©å®ä¾‹
        function selectInstance(instanceId) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            const instanceItems = document.querySelectorAll('.instance-item');
            instanceItems.forEach(item => {
                const itemId = item.getAttribute('data-id');
                if (itemId === instanceId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // æ›´æ–°é€‰ä¸­çš„å®ä¾‹ID
            selectedInstanceId = instanceId;
            
            // æ›´æ–°æ§åˆ¶å°æ ‡é¢˜
            updateConsoleTitle();
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonState();
            
            // å¦‚æœæ§åˆ¶å°å·²è¿æ¥åˆ°å…¶ä»–å®ä¾‹ï¼Œæ–­å¼€è¿æ¥
            if (consoleConnected && selectedInstanceId && console_instance_id !== selectedInstanceId) {
                disconnectConsole();
            }
        }
        
        // æ›´æ–°æ§åˆ¶å°æ ‡é¢˜
        function updateConsoleTitle() {
            const consoleTitle = document.getElementById('consoleTitle');
            if (selectedInstanceId) {
                const selectedInstance = document.querySelector(`.instance-item[data-id="${selectedInstanceId}"]`);
                if (selectedInstance) {
                    const instanceName = selectedInstance.querySelector('.instance-name').textContent;
                    consoleTitle.textContent = `æ§åˆ¶å° - ${instanceName}`;
                } else {
                    consoleTitle.textContent = `æ§åˆ¶å° - ${selectedInstanceId}`;
                }
            } else {
                consoleTitle.textContent = 'æ§åˆ¶å°';
            }
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonState() {
            const connectButton = document.getElementById('connectButton');
            const clearButton = document.getElementById('clearButton');
            const consoleInput = document.getElementById('consoleInput');
            const submitButton = document.getElementById('submitButton');
            
            if (selectedInstanceId) {
                connectButton.disabled = false;
                connectButton.textContent = consoleConnected ? 'æ–­å¼€æ§åˆ¶å°' : 'è¿æ¥æ§åˆ¶å°';
                clearButton.disabled = !consoleConnected;
                consoleInput.disabled = !consoleConnected;
                submitButton.disabled = !consoleConnected;
            } else {
                connectButton.disabled = true;
                clearButton.disabled = true;
                consoleInput.disabled = true;
                submitButton.disabled = true;
                connectButton.textContent = 'è¿æ¥æ§åˆ¶å°';
            }
            
            // ç¡®ä¿è¾“å…¥æ¡†å¯ä»¥æ¥æ”¶è¾“å…¥
            if (!consoleInput.disabled) {
                consoleInput.focus();
            }
        }
        
        // åˆ‡æ¢æ§åˆ¶å°è¿æ¥çŠ¶æ€
        function toggleConsoleConnection() {
            if (!selectedInstanceId) return;
            
            if (consoleConnected) {
                disconnectConsole();
            } else {
                connectConsole();
            }
        }
        
        // è¿æ¥æ§åˆ¶å°
        function connectConsole() {
            if (!selectedInstanceId) return;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œä½†ä¸æ¸…ç©ºç°æœ‰æ¶ˆæ¯
            const consoleOutput = document.getElementById('consoleOutput');
            // æ·»åŠ ä¸€ä¸ªåŠ è½½æŒ‡ç¤ºå™¨ï¼Œè€Œä¸æ˜¯æ›¿æ¢æ•´ä¸ªå†…å®¹
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading';
            loadingIndicator.innerHTML = '<div class="loading-spinner"></div><div class="loading-text">æ­£åœ¨è¿æ¥æ§åˆ¶å°...</div>';
            loadingIndicator.style.position = 'absolute';
            loadingIndicator.style.top = '50%';
            loadingIndicator.style.left = '50%';
            loadingIndicator.style.transform = 'translate(-50%, -50%)';
            loadingIndicator.style.padding = '20px';
            loadingIndicator.style.borderRadius = '5px';
            loadingIndicator.style.zIndex = '1000';
            loadingIndicator.id = 'loadingIndicator';
            
            // å¦‚æœå·²ç»æœ‰åŠ è½½æŒ‡ç¤ºå™¨ï¼Œå…ˆç§»é™¤
            const existingIndicator = document.getElementById('loadingIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
            consoleOutput.appendChild(loadingIndicator);
            
            // å‘é€è¿æ¥è¯·æ±‚
            fetch('/api/console/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    instance_id: selectedInstanceId
                })
            })
            .then(response => response.json())
            .then(data => {
                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                if (data.success) {
                    // è¿æ¥æˆåŠŸï¼Œæ›´æ–°çŠ¶æ€
                    consoleConnected = true;
                    console_instance_id = selectedInstanceId;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateButtonState();
                    
                    // ä¸æ¸…ç©ºæ§åˆ¶å°ï¼Œä¿ç•™ç°æœ‰æ¶ˆæ¯
                    // document.getElementById('consoleOutput').innerHTML = '';
                    
                    // æ˜¾ç¤ºè¿æ¥æˆåŠŸæ¶ˆæ¯
                    appendSystemMessage('success', `å·²è¿æ¥åˆ°å®ä¾‹: ${selectedInstanceId}`);
                    appendSystemMessage('info', 'æ§åˆ¶å°å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ‰§è¡ŒJavaScriptå‘½ä»¤');
                    
                    // èšç„¦è¾“å…¥æ¡†
                    setTimeout(() => {
                        const consoleInput = document.getElementById('consoleInput');
                        if (consoleInput) {
                            consoleInput.disabled = false;
                            consoleInput.focus();
                        }
                    }, 100);
                } else {
                    // è¿æ¥å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œä½†ä¸æ¸…ç©ºç°æœ‰æ¶ˆæ¯
                    appendSystemMessage('error', `è¿æ¥å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            })
            .catch(error => {
                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                console.error('è¿æ¥æ§åˆ¶å°å¤±è´¥:', error);
                appendSystemMessage('error', `è¿æ¥å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}`);
            });
        }
        
        // æ–­å¼€æ§åˆ¶å°è¿æ¥
        function disconnectConsole() {
            fetch('/api/console/disconnect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    appendSystemMessage('error', `æ–­å¼€è¿æ¥å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            })
            .catch(error => {
                console.error('æ–­å¼€æ§åˆ¶å°è¿æ¥å¤±è´¥:', error);
                appendSystemMessage('error', 'æ–­å¼€è¿æ¥å¤±è´¥: ç½‘ç»œé”™è¯¯');
            });
        }
        
        // æ¸…ç©ºæ§åˆ¶å°
        function clearConsole() {
            if (!consoleConnected) return;
            
            fetch('/api/console/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('consoleOutput').innerHTML = '';
                    appendSystemMessage('info', 'æ§åˆ¶å°å·²æ¸…ç©º');
                } else {
                    appendSystemMessage('error', `æ¸…ç©ºæ§åˆ¶å°å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            })
            .catch(error => {
                console.error('æ¸…ç©ºæ§åˆ¶å°å¤±è´¥:', error);
                appendSystemMessage('error', 'æ¸…ç©ºæ§åˆ¶å°å¤±è´¥: ç½‘ç»œé”™è¯¯');
            });
        }
        
        // å‘é€å‘½ä»¤
        function sendCommand() {
            const consoleInput = document.getElementById('consoleInput');
            const command = consoleInput.value.trim();
            
            if (!command) return;
            
            // ç¦ç”¨è¾“å…¥æ¡†ï¼Œé˜²æ­¢é‡å¤æäº¤
            consoleInput.disabled = true;
            document.getElementById('submitButton').disabled = true;
            
            console.log('å‡†å¤‡å‘é€å‘½ä»¤:', command);
            
            // é€šè¿‡WebSocketå‘é€å‘½ä»¤ï¼ˆæ·»åŠ æ­¤éƒ¨åˆ†ï¼‰
            if (socket && socket.connected) {
                console.log('ä½¿ç”¨WebSocketå‘é€å‘½ä»¤');
                socket.emit('console_command', {
                    command: command,
                    timestamp: Date.now()
                });
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                consoleInput.value = '';
                consoleInput.style.height = '38px'; // é‡ç½®é«˜åº¦
                
                // é‡æ–°å¯ç”¨è¾“å…¥æ¡†
                consoleInput.disabled = false;
                document.getElementById('submitButton').disabled = false;
                consoleInput.focus();
                
                console.log('WebSocketå‘½ä»¤å·²å‘é€');
                return; // ä½¿ç”¨WebSocketå‘é€åç›´æ¥è¿”å›ï¼Œä¸å†ä½¿ç”¨HTTPè¯·æ±‚
            }
            
            console.log('WebSocketä¸å¯ç”¨ï¼Œä½¿ç”¨HTTPè¯·æ±‚å‘é€å‘½ä»¤');
            
            // å¦‚æœWebSocketä¸å¯ç”¨ï¼Œåˆ™ä½¿ç”¨HTTPè¯·æ±‚ï¼ˆä¿ç•™åŸæœ‰ä»£ç ä½œä¸ºå¤‡ç”¨ï¼‰
            fetch('/api/console/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: command
                })
            })
            .then(response => response.json())
            .then(data => {
                // æ¸…ç©ºè¾“å…¥æ¡†
                consoleInput.value = '';
                consoleInput.style.height = '38px'; // é‡ç½®é«˜åº¦
                
                // é‡æ–°å¯ç”¨è¾“å…¥æ¡†
                consoleInput.disabled = false;
                document.getElementById('submitButton').disabled = false;
                consoleInput.focus();
                
                // å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                if (!data.success) {
                    appendSystemMessage('error', `å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            })
            .catch(error => {
                console.error('æ‰§è¡Œå‘½ä»¤å¤±è´¥:', error);
                
                // é‡æ–°å¯ç”¨è¾“å…¥æ¡†
                consoleInput.disabled = false;
                document.getElementById('submitButton').disabled = false;
                consoleInput.focus();
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                appendSystemMessage('error', `å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}`);
            });
        }
        
        // æ·»åŠ æ§åˆ¶å°æ¶ˆæ¯
        function appendConsoleMessage(message) {
            const consoleOutput = document.getElementById('consoleOutput');
            
            // è°ƒè¯•æ—¥å¿—
            console.log('æ·»åŠ æ§åˆ¶å°æ¶ˆæ¯:', message);
            
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageElement = document.createElement('div');
            messageElement.className = `console-message message-${message.level || 'log'}`;
            
            // åˆ›å»ºæ—¶é—´æˆ³
            const timestamp = new Date(message.timestamp).toLocaleTimeString();
            const timestampElement = document.createElement('span');
            timestampElement.className = 'message-timestamp';
            timestampElement.textContent = timestamp;
            
            // æ·»åŠ æ—¶é—´æˆ³
            messageElement.appendChild(timestampElement);
            
            // å¤„ç†æ¶ˆæ¯å†…å®¹
            let content = message.content || '';
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®å†…å®¹
            if (message.type === 'input') {
                // å‘½ä»¤è¾“å…¥
                messageElement.className = 'console-message message-input';
                
                // åˆ›å»ºå‘½ä»¤å‰ç¼€
                const prefixSpan = document.createElement('span');
                prefixSpan.className = 'command-prefix';
                prefixSpan.textContent = '> ';
                messageElement.appendChild(prefixSpan);
                
                // æ·»åŠ å‘½ä»¤å†…å®¹
                messageElement.appendChild(document.createTextNode(content));
                console.log('æ·»åŠ è¾“å…¥æ¶ˆæ¯:', content);
            } else if (message.type === 'system') {
                // ç³»ç»Ÿæ¶ˆæ¯
                messageElement.className = `console-message message-system`;
                messageElement.appendChild(document.createTextNode(content));
                console.log('æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯:', content);
            } else if (message.type === 'error') {
                // é”™è¯¯æ¶ˆæ¯
                messageElement.className = 'console-message message-error';
                
                // åˆ›å»ºé”™è¯¯å‰ç¼€
                const errorPrefix = document.createElement('span');
                errorPrefix.className = 'error-prefix';
                errorPrefix.textContent = 'Error: ';
                messageElement.appendChild(errorPrefix);
                
                // æ·»åŠ é”™è¯¯å†…å®¹
                messageElement.appendChild(document.createTextNode(content));
                console.log('æ·»åŠ é”™è¯¯æ¶ˆæ¯:', content);
            } else if (message.type === 'result') {
                // ç»“æœæ¶ˆæ¯
                messageElement.className = 'console-message message-result';
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯JSONå­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯åˆ™æ ¼å¼åŒ–æ˜¾ç¤º
                try {
                    if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
                        const jsonObj = JSON.parse(content);
                        content = JSON.stringify(jsonObj, null, 2);
                        
                        // ä½¿ç”¨preæ ‡ç­¾ä¿ç•™æ ¼å¼
                        const preElement = document.createElement('pre');
                        preElement.className = 'json-content';
                        preElement.textContent = content;
                        messageElement.appendChild(preElement);
                        console.log('æ·»åŠ æ ¼å¼åŒ–JSONç»“æœæ¶ˆæ¯');
                        return messageElement;
                    }
                } catch (e) {
                    // ä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œç»§ç»­ä½¿ç”¨æ™®é€šæ–‡æœ¬
                    console.log('ç»“æœä¸æ˜¯æœ‰æ•ˆJSONï¼Œä½¿ç”¨æ™®é€šæ–‡æœ¬æ˜¾ç¤º');
                }
                
                messageElement.appendChild(document.createTextNode(content));
                console.log('æ·»åŠ ç»“æœæ¶ˆæ¯:', content.substring(0, 100) + (content.length > 100 ? '...' : ''));
            } else {
                // æ™®é€šæ§åˆ¶å°æ¶ˆæ¯
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å¤šè¡Œæ–‡æœ¬
                if (content.includes('\n')) {
                    // ä½¿ç”¨preæ ‡ç­¾ä¿ç•™æ ¼å¼
                    const preElement = document.createElement('pre');
                    preElement.className = 'multiline-content';
                    preElement.textContent = content;
                    messageElement.appendChild(preElement);
                    console.log('æ·»åŠ å¤šè¡Œæ¶ˆæ¯');
                } else {
                    messageElement.appendChild(document.createTextNode(content));
                    console.log('æ·»åŠ æ™®é€šæ¶ˆæ¯:', content.substring(0, 100) + (content.length > 100 ? '...' : ''));
                }
            }
            
            // æ·»åŠ åˆ°æ§åˆ¶å°
            consoleOutput.appendChild(messageElement);
            console.log('æ¶ˆæ¯å…ƒç´ å·²æ·»åŠ åˆ°DOM');
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console.log('æ§åˆ¶å°å·²æ»šåŠ¨åˆ°åº•éƒ¨');
            
            // è¿”å›æ·»åŠ çš„å…ƒç´ ï¼Œæ–¹ä¾¿è°ƒè¯•
            return messageElement;
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function appendSystemMessage(level, message) {
            const consoleOutput = document.getElementById('consoleOutput');
            
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageElement = document.createElement('div');
            messageElement.className = `console-message message-${level}`;
            
            // åˆ›å»ºæ—¶é—´æˆ³
            const timestamp = new Date().toLocaleTimeString();
            const timestampElement = document.createElement('span');
            timestampElement.className = 'message-timestamp';
            timestampElement.textContent = timestamp;
            
            // æ·»åŠ æ—¶é—´æˆ³å’Œæ¶ˆæ¯
            messageElement.appendChild(timestampElement);
            messageElement.appendChild(document.createTextNode(message));
            
            // æ·»åŠ åˆ°æ§åˆ¶å°
            consoleOutput.appendChild(messageElement);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            switch (status) {
                case 'ready':
                    return 'status-ready';
                case 'error':
                    return 'status-error';
                case 'initializing':
                    return 'status-initializing';
                default:
                    return '';
            }
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch (status) {
                case 'ready':
                    return 'å°±ç»ª';
                case 'error':
                    return 'é”™è¯¯';
                case 'initializing':
                    return 'åˆå§‹åŒ–ä¸­';
                case 'created':
                    return 'å·²åˆ›å»º';
                case 'terminated':
                    return 'å·²ç»ˆæ­¢';
                default:
                    return status;
            }
        }
        
        // è·å–æ¶ˆæ¯æ ·å¼ç±»
        function getMessageClass(type, level) {
            if (type === 'system') {
                return 'message-system';
            }
            
            switch (level) {
                case 'info':
                    return 'message-info';
                case 'warning':
                    return 'message-warning';
                case 'error':
                    return 'message-error';
                default:
                    return 'message-log';
            }
        }
        
        // å¯åŠ¨å¿ƒè·³
        function startSessionHeartbeat() {
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å¿ƒè·³
            if (sessionHeartbeatInterval) {
                clearInterval(sessionHeartbeatInterval);
            }
            
            // è®¾ç½®å¿ƒè·³é—´éš”ä¸º15åˆ†é’Ÿï¼ˆ900000æ¯«ç§’ï¼‰
            // è¿™ä¸ªå€¼åº”å°äºæœåŠ¡å™¨ç«¯éªŒè¯é—´éš”ï¼ˆ30åˆ†é’Ÿï¼‰
            sessionHeartbeatInterval = setInterval(async function() {
                console.log("æ‰§è¡Œä¼šè¯å¿ƒè·³...");
                try {
                    // å‘é€ä»¤ç‰ŒéªŒè¯è¯·æ±‚
                    const response = await fetch('/api/verify-token', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log("ä¼šè¯å¿ƒè·³æˆåŠŸï¼Œä»¤ç‰Œæœ‰æ•ˆ");
                    } else {
                        console.warn("ä¼šè¯å¿ƒè·³å¤±è´¥ï¼Œä»¤ç‰Œå¯èƒ½å·²å¤±æ•ˆ:", result.message);
                        // å¦‚æœä»¤ç‰ŒéªŒè¯å¤±è´¥ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                        if (result.error_code === 'TOKEN_EXPIRED' || result.error_code === 'NOT_AUTHENTICATED') {
                            window.location.href = '/login';
                        }
                    }
                } catch (error) {
                    console.error("ä¼šè¯å¿ƒè·³è¯·æ±‚å¼‚å¸¸:", error);
                    // ç½‘ç»œé”™è¯¯ä¸åšå¤„ç†ï¼Œç­‰å¾…ä¸‹æ¬¡å¿ƒè·³
                }
            }, 900000); // 15åˆ†é’Ÿ
            
            console.log("ä¼šè¯å¿ƒè·³æœºåˆ¶å·²å¯åŠ¨");
        }
        
        // åˆå§‹åŒ–äº‹ä»¶å¤„ç†
        function initEventHandlers() {
            console.log('åˆå§‹åŒ–äº‹ä»¶å¤„ç†å™¨');
            
            // è¿æ¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('connectButton').addEventListener('click', toggleConsoleConnection);
            
            // æ¸…ç©ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('clearButton').addEventListener('click', clearConsole);
            
            // æäº¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('submitButton').addEventListener('click', sendCommand);
            
            // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('refreshButton').addEventListener('click', function() {
                console.log('åˆ·æ–°å®ä¾‹åˆ—è¡¨');
                loadInstances();
            });
            
            // è¡¨å•æäº¤äº‹ä»¶ï¼ˆé˜²æ­¢åˆ·æ–°é¡µé¢ï¼‰
            document.getElementById('consoleForm').addEventListener('submit', function(event) {
                console.log('æ•è·consoleFormæäº¤äº‹ä»¶ï¼Œé˜»æ­¢é»˜è®¤åˆ·æ–°');
                event.preventDefault();
                sendCommand();
            });
            
            // è¾“å…¥æ¡†Enteré”®äº‹ä»¶
            const consoleInput = document.getElementById('consoleInput');
            consoleInput.addEventListener('keydown', function(event) {
                // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº†Enteré”®ä¸”æ²¡æœ‰æŒ‰ä¸‹Shifté”®ï¼ˆShift+Enterç”¨äºæ¢è¡Œï¼‰
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆæ¢è¡Œï¼‰
                    sendCommand(); // å‘é€å‘½ä»¤
                }
            });
            
            // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            consoleInput.addEventListener('input', function() {
                this.style.height = '38px'; // é‡ç½®é«˜åº¦
                this.style.height = (this.scrollHeight) + 'px'; // è®¾ç½®æ–°é«˜åº¦
            });
            
            // å®ä¾‹åˆ—è¡¨ç‚¹å‡»äº‹ä»¶
            document.getElementById('instanceList').addEventListener('click', function(e) {
                const instanceItem = e.target.closest('.instance-item');
                if (instanceItem) {
                    const instanceId = instanceItem.getAttribute('data-id');
                    selectInstance(instanceId);
                }
            });
            
            console.log('äº‹ä»¶å¤„ç†å™¨åˆå§‹åŒ–å®Œæˆ');
        }
    </script>
</body>
</html>