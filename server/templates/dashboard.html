<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Botç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            background-color: #1e1e1e;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #333;
        }
        
        .status-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .status-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .system-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4caf50;
        }
        
        .status-text {
            font-size: 14px;
            color: #aaaaaa;
        }
        
        .status-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #4a6ed3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5ec3;
        }
        
        .btn-secondary {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        
        .btn-secondary:hover {
            background-color: #333333;
        }
        
        .btn-danger {
            background-color: #d32f2f;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c62828;
        }
        
        /* ä¸»è¦å†…å®¹ç½‘æ ¼ */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 500;
            color: #ffffff;
            margin: 0;
        }
        
        .card-action {
            padding: 4px 8px;
            background-color: #4a6ed3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .card-action:hover {
            background-color: #3a5ec3;
        }
        
        /* ç»Ÿè®¡é¡¹ */
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            background-color: #252525;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #333;
        }
        
        .stat-label {
            font-size: 13px;
            color: #aaaaaa;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .stat-value.success {
            color: #4caf50;
        }
        
        .stat-value.error {
            color: #f44336;
        }
        
        .stat-value.warning {
            color: #ff9800;
        }
        
        /* å®ä¾‹åˆ—è¡¨ã€ç”¨æˆ·èµ„æ–™åˆ—è¡¨å’Œåˆ†ç»„åˆ—è¡¨ */
        .instance-list, .profile-list, .group-list {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .instance-item, .profile-item, .group-item {
            background-color: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .instance-info h4, .profile-info h4, .group-info h4 {
            margin: 0 0 4px 0;
            color: #ffffff;
            font-size: 13px;
        }
        
        .instance-info p, .profile-info p, .group-info p {
            margin: 0;
            font-size: 11px;
            color: #aaaaaa;
        }
        
        .instance-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .instance-actions, .profile-actions, .group-actions {
            display: flex;
            gap: 4px;
        }
        
        .instance-actions button, .profile-actions button, .group-actions button {
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        
        /* JSæ³¨å…¥ç›¸å…³æ ·å¼ */
        .js-injection-container {
            display: grid;
            gap: 15px;
        }
        
        .js-modules {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .js-module-btn {
            padding: 6px 12px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .js-module-btn:hover {
            background-color: #4a6ed3;
            border-color: #4a6ed3;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: #1e1e1e;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            margin: 0;
            color: #ffffff;
            font-size: 18px;
        }
        
        .close {
            color: #aaaaaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #ffffff;
        }
        
        /* æ—¥å¿—è¾“å‡º */
        .log-output {
            background-color: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            color: #e0e0e0;
            height: 200px;
            overflow-y: auto;
        }
        
        .log-line {
            margin-bottom: 3px;
        }
        
        .log-timestamp {
            color: #666666;
            margin-right: 8px;
        }
        
        .log-level-info {
            color: #64b5f6;
        }
        
        .log-level-error {
            color: #e57373;
        }
        
        .log-level-warning {
            color: #ffb74d;
        }
        
        /* é…ç½®è¡¨å• */
        .config-form {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-size: 13px;
            color: #aaaaaa;
        }
        
        .form-input {
            padding: 8px 12px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #ffffff;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4a6ed3;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666666;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #4a6ed3;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-left">
            <div class="status-title">Telegram Botç®¡ç†ç³»ç»Ÿ</div>
            <div class="system-status">
                <div class="status-indicator" id="system-status-indicator"></div>
                <span class="status-text" id="system-status-text">ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
            </div>
        </div>
        <div class="status-actions">
            <button class="btn btn-primary" id="create-instance-btn">åˆ›å»ºå®ä¾‹</button>
            <button class="btn btn-secondary" id="refresh-btn">åˆ·æ–°</button>
            <button class="btn btn-danger" id="logout-btn">æ³¨é”€</button>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ç½‘æ ¼ -->
    <div class="content-grid">
        <!-- ç³»ç»Ÿç»Ÿè®¡ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ç³»ç»Ÿç»Ÿè®¡</h3>
                <button class="card-action" onclick="loadSystemStats()">åˆ·æ–°</button>
            </div>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-label">æ€»å®ä¾‹æ•°</div>
                    <div class="stat-value" id="total-instances">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ´»è·ƒå®ä¾‹</div>
                    <div class="stat-value success" id="active-instances">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">é”™è¯¯å®ä¾‹</div>
                    <div class="stat-value error" id="error-instances">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">è¿è¡Œæ—¶é—´</div>
                    <div class="stat-value" id="system-uptime">-</div>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·èµ„æ–™ç®¡ç† -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ç”¨æˆ·èµ„æ–™</h3>
                <button class="card-action" onclick="showCreateProfileModal()">æ–°å»º</button>
            </div>
            <div class="profile-list" id="profile-list">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¤</div>
                    <p>æš‚æ— èµ„æ–™</p>
                </div>
            </div>
        </div>

        <!-- åˆ†ç»„ç®¡ç† -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">åˆ†ç»„ç®¡ç†</h3>
                <button class="card-action" onclick="showCreateGroupModal()">æ–°å»º</button>
            </div>
            <div class="group-list" id="group-list">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <p>æš‚æ— åˆ†ç»„</p>
                </div>
            </div>
        </div>

        <!-- å®ä¾‹åˆ—è¡¨ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">å®ä¾‹åˆ—è¡¨</h3>
                <button class="card-action" onclick="loadInstances()">åˆ·æ–°</button>
            </div>
            <div class="instance-list" id="instance-list">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“±</div>
                    <p>æš‚æ— å®ä¾‹</p>
                </div>
            </div>
        </div>

        <!-- JavaScriptæ³¨å…¥ -->
        <div class="card" style="grid-column: span 2;">
            <div class="card-header">
                <h3 class="card-title">JavaScriptæ³¨å…¥</h3>
                <button class="card-action" onclick="loadJsModules()">åˆ·æ–°</button>
            </div>
            <div class="js-injection-container">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©å®ä¾‹</label>
                        <select class="form-input" id="target-instance">
                            <option value="">è¯·é€‰æ‹©å®ä¾‹</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é¢„è®¾æ¨¡å—</label>
                        <div class="js-modules" id="js-modules">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">JavaScriptä»£ç </label>
                    <textarea class="form-input" id="js-code" rows="6" placeholder="è¾“å…¥è¦æ³¨å…¥çš„JavaScriptä»£ç ..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="executeJs()">æ‰§è¡Œæ³¨å…¥</button>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºå®ä¾‹æ¨¡æ€æ¡† -->
    <div id="create-instance-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">åˆ›å»ºæ–°å®ä¾‹</h3>
                <span class="close" onclick="closeCreateInstanceModal()">&times;</span>
            </div>
            <div class="config-form">
                <div class="form-group">
                    <label class="form-label">å®ä¾‹åç§°</label>
                    <input type="text" class="form-input" id="new-instance-name" placeholder="è¾“å…¥å®ä¾‹åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©ç”¨æˆ·èµ„æ–™</label>
                    <select class="form-input" id="new-instance-profile">
                        <option value="default">é»˜è®¤èµ„æ–™</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©åˆ†ç»„</label>
                    <select class="form-input" id="new-instance-group">
                        <option value="default">é»˜è®¤åˆ†ç»„</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="confirmCreateInstance()">ç¡®è®¤åˆ›å»º</button>
                <button class="btn btn-secondary" onclick="closeCreateInstanceModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºç”¨æˆ·èµ„æ–™æ¨¡æ€æ¡† -->
    <div id="create-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">åˆ›å»ºç”¨æˆ·èµ„æ–™</h3>
                <span class="close" onclick="closeCreateProfileModal()">&times;</span>
            </div>
            <div class="config-form">
                <div class="form-group">
                    <label class="form-label">èµ„æ–™åç§°</label>
                    <input type="text" class="form-input" id="new-profile-name" placeholder="è¾“å…¥èµ„æ–™åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-input" id="new-profile-description" rows="3" placeholder="è¾“å…¥èµ„æ–™æè¿°"></textarea>
                </div>
                <button class="btn btn-primary" onclick="confirmCreateProfile()">ç¡®è®¤åˆ›å»º</button>
                <button class="btn btn-secondary" onclick="closeCreateProfileModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºåˆ†ç»„æ¨¡æ€æ¡† -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">åˆ›å»ºåˆ†ç»„</h3>
                <span class="close" onclick="closeCreateGroupModal()">&times;</span>
            </div>
            <div class="config-form">
                <div class="form-group">
                    <label class="form-label">åˆ†ç»„åç§°</label>
                    <input type="text" class="form-input" id="new-group-name" placeholder="è¾“å…¥åˆ†ç»„åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">åˆ†ç»„æè¿°</label>
                    <textarea class="form-input" id="new-group-description" rows="3" placeholder="è¾“å…¥åˆ†ç»„æè¿°"></textarea>
                </div>
                <button class="btn btn-primary" onclick="confirmCreateGroup()">ç¡®è®¤åˆ›å»º</button>
                <button class="btn btn-secondary" onclick="closeCreateGroupModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        console.log('[DASHBOARD] - INFO - ä»ªè¡¨æ¿é¡µé¢è„šæœ¬åŠ è½½');

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[DASHBOARD] - INFO - ä»ªè¡¨æ¿é¡µé¢åˆå§‹åŒ–');
            initializePage();
        });

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            loadSystemStats();
            loadInstances();
            loadProfiles();
            loadGroups();
            loadJsModules();
            bindEvents();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            setInterval(loadSystemStats, 30000);
            setInterval(loadInstances, 60000);
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // åˆ›å»ºå®ä¾‹æŒ‰é’®
            document.getElementById('create-instance-btn').addEventListener('click', showCreateInstanceModal);
            
            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refresh-btn').addEventListener('click', function() {
                loadSystemStats();
                loadInstances();
                loadProfiles();
                loadGroups();
                loadJsModules();
            });
            
            // æ³¨é”€æŒ‰é’®
            document.getElementById('logout-btn').addEventListener('click', logout);
        }

        // åŠ è½½ç³»ç»Ÿç»Ÿè®¡
        function loadSystemStats() {
            console.log('[DASHBOARD] - INFO - åŠ è½½ç³»ç»Ÿç»Ÿè®¡');
            
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSystemStats(data.data);
                        updateSystemStatus('connected', 'ç³»ç»Ÿè¿è¡Œæ­£å¸¸');
                    } else {
                        updateSystemStatus('error', 'ç³»ç»Ÿé”™è¯¯');
                    }
                })
                .catch(error => {
                    console.error('[DASHBOARD] - ERROR - åŠ è½½ç³»ç»Ÿç»Ÿè®¡å¤±è´¥:', error);
                    updateSystemStatus('error', 'è¿æ¥å¤±è´¥');
                });
        }

        // æ›´æ–°ç³»ç»Ÿç»Ÿè®¡
        function updateSystemStats(stats) {
            document.getElementById('total-instances').textContent = stats.instances?.total || 0;
            document.getElementById('active-instances').textContent = stats.instances?.active || 0;
            document.getElementById('error-instances').textContent = stats.instances?.error || 0;
            
            if (stats.server?.uptime) {
                const hours = Math.floor(stats.server.uptime / 3600);
                const minutes = Math.floor((stats.server.uptime % 3600) / 60);
                document.getElementById('system-uptime').textContent = `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            }
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(status, text) {
            const indicator = document.getElementById('system-status-indicator');
            const statusText = document.getElementById('system-status-text');
            
            indicator.className = 'status-indicator';
            if (status === 'connected') {
                indicator.style.backgroundColor = '#4caf50';
            } else if (status === 'error') {
                indicator.style.backgroundColor = '#f44336';
            }
            
            statusText.textContent = text;
        }

        // åŠ è½½å®ä¾‹åˆ—è¡¨
        function loadInstances() {
            console.log('[DASHBOARD] - INFO - åŠ è½½å®ä¾‹åˆ—è¡¨');
            
            fetch('/api/instances')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateInstancesList(data.data);
                    }
                })
                .catch(error => {
                    console.error('[DASHBOARD] - ERROR - åŠ è½½å®ä¾‹åˆ—è¡¨å¤±è´¥:', error);
                });
        }

        // æ›´æ–°å®ä¾‹åˆ—è¡¨
        function updateInstancesList(instances) {
            const container = document.getElementById('instance-list');
            const targetInstanceSelect = document.getElementById('target-instance');
            
            if (!instances || instances.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“±</div>
                        <p>æš‚æ— å®ä¾‹</p>
                    </div>
                `;
                targetInstanceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å®ä¾‹</option>';
                return;
            }
            
            // æ›´æ–°å®ä¾‹åˆ—è¡¨æ˜¾ç¤º
            container.innerHTML = instances.map(instance => `
                <div class="instance-item">
                    <div class="instance-info">
                        <h4>${instance.name || instance.id}</h4>
                        <p>èµ„æ–™: ${instance.profile_id || 'default'} | åˆ›å»º: ${formatTime(instance.created_at)}</p>
                    </div>
                    <div class="instance-status ${getStatusClass(instance.status)}">
                        ${getStatusText(instance.status)}
                    </div>
                    <div class="instance-actions">
                        <button class="btn btn-danger" onclick="destroyInstance('${instance.id}')">é”€æ¯</button>
                    </div>
                </div>
            `).join('');
            
            // æ›´æ–°JSæ³¨å…¥çš„å®ä¾‹é€‰æ‹©å™¨
            targetInstanceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å®ä¾‹</option>' + 
                instances.map(instance => `
                    <option value="${instance.id}">${instance.name || instance.id}</option>
                `).join('');
        }

        // åŠ è½½ç”¨æˆ·èµ„æ–™åˆ—è¡¨
        function loadProfiles() {
            console.log('[DASHBOARD] - INFO - åŠ è½½ç”¨æˆ·èµ„æ–™åˆ—è¡¨');
            
            // æ¨¡æ‹Ÿè·å–ç”¨æˆ·èµ„æ–™æ•°æ®
            setTimeout(() => {
                const profiles = [
                    { id: 'default', name: 'é»˜è®¤èµ„æ–™', description: 'ç³»ç»Ÿé»˜è®¤ç”¨æˆ·èµ„æ–™', created_at: Date.now() / 1000 }
                ];
                updateProfilesList(profiles);
            }, 500);
        }

        // æ›´æ–°ç”¨æˆ·èµ„æ–™åˆ—è¡¨
        function updateProfilesList(profiles) {
            const container = document.getElementById('profile-list');
            const profileSelect = document.getElementById('new-instance-profile');
            
            if (!profiles || profiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¤</div>
                        <p>æš‚æ— èµ„æ–™</p>
                    </div>
                `;
                return;
            }
            
            // æ›´æ–°èµ„æ–™åˆ—è¡¨æ˜¾ç¤º
            container.innerHTML = profiles.map(profile => `
                <div class="profile-item">
                    <div class="profile-info">
                        <h4>${profile.name}</h4>
                        <p>${profile.description || 'æš‚æ— æè¿°'}</p>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-secondary" onclick="editProfile('${profile.id}')">ç¼–è¾‘</button>
                        ${profile.id !== 'default' ? `<button class="btn btn-danger" onclick="deleteProfile('${profile.id}')">åˆ é™¤</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            // æ›´æ–°åˆ›å»ºå®ä¾‹æ—¶çš„èµ„æ–™é€‰æ‹©å™¨
            profileSelect.innerHTML = profiles.map(profile => `
                <option value="${profile.id}">${profile.name}</option>
            `).join('');
        }

        // åŠ è½½åˆ†ç»„åˆ—è¡¨
        function loadGroups() {
            console.log('[DASHBOARD] - INFO - åŠ è½½åˆ†ç»„åˆ—è¡¨');
            
            // æ¨¡æ‹Ÿè·å–åˆ†ç»„æ•°æ®
            setTimeout(() => {
                const groups = [
                    { id: 'default', name: 'é»˜è®¤åˆ†ç»„', description: 'ç³»ç»Ÿé»˜è®¤åˆ†ç»„', instance_count: 0, created_at: Date.now() / 1000 }
                ];
                updateGroupsList(groups);
            }, 500);
        }

        // æ›´æ–°åˆ†ç»„åˆ—è¡¨
        function updateGroupsList(groups) {
            const container = document.getElementById('group-list');
            const groupSelect = document.getElementById('new-instance-group');
            
            if (!groups || groups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <p>æš‚æ— åˆ†ç»„</p>
                    </div>
                `;
                return;
            }
            
            // æ›´æ–°åˆ†ç»„åˆ—è¡¨æ˜¾ç¤º
            container.innerHTML = groups.map(group => `
                <div class="group-item">
                    <div class="group-info">
                        <h4>${group.name}</h4>
                        <p>å®ä¾‹æ•°: ${group.instance_count || 0} | ${group.description || 'æš‚æ— æè¿°'}</p>
                    </div>
                    <div class="group-actions">
                        <button class="btn btn-secondary" onclick="editGroup('${group.id}')">ç¼–è¾‘</button>
                        ${group.id !== 'default' ? `<button class="btn btn-danger" onclick="deleteGroup('${group.id}')">åˆ é™¤</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            // æ›´æ–°åˆ›å»ºå®ä¾‹æ—¶çš„åˆ†ç»„é€‰æ‹©å™¨
            groupSelect.innerHTML = groups.map(group => `
                <option value="${group.id}">${group.name}</option>
            `).join('');
        }

        // åŠ è½½JavaScriptæ¨¡å—
        function loadJsModules() {
            console.log('[DASHBOARD] - INFO - åŠ è½½JavaScriptæ¨¡å—');
            
            const container = document.getElementById('js-modules');
            
            // æ¨¡æ‹Ÿè·å–JSæ¨¡å—æ•°æ®
            setTimeout(() => {
                const modules = [
                    'telegram_utils.js',
                    'message_sender.js',
                    'contact_manager.js',
                    'auto_reply.js',
                    'media_handler.js'
                ];
                
                container.innerHTML = modules.map(module => `
                    <button class="js-module-btn" onclick="loadJsModule('${module}')">${module}</button>
                `).join('');
            }, 800);
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            switch(status) {
                case 'ready': return 'success';
                case 'error': return 'error';
                case 'initializing': return 'warning';
                default: return '';
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch(status) {
                case 'ready': return 'å°±ç»ª';
                case 'error': return 'é”™è¯¯';
                case 'initializing': return 'åˆå§‹åŒ–';
                case 'terminated': return 'å·²ç»ˆæ­¢';
                default: return status;
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp * 1000).toLocaleString('zh-CN');
        }

        // æ˜¾ç¤ºåˆ›å»ºå®ä¾‹æ¨¡æ€æ¡†
        function showCreateInstanceModal() {
            document.getElementById('create-instance-modal').style.display = 'block';
        }

        // å…³é—­åˆ›å»ºå®ä¾‹æ¨¡æ€æ¡†
        function closeCreateInstanceModal() {
            document.getElementById('create-instance-modal').style.display = 'none';
            document.getElementById('new-instance-name').value = '';
        }

        // ç¡®è®¤åˆ›å»ºå®ä¾‹
        function confirmCreateInstance() {
            const instanceName = document.getElementById('new-instance-name').value;
            const profileId = document.getElementById('new-instance-profile').value;
            const groupId = document.getElementById('new-instance-group').value;
            
            if (!instanceName.trim()) {
                alert('è¯·è¾“å…¥å®ä¾‹åç§°');
                return;
            }
            
            console.log('[DASHBOARD] - INFO - åˆ›å»ºå®ä¾‹:', instanceName);
            
            fetch('/api/instances', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: instanceName,
                    group_id: groupId || 'default',
                    profile_id: profileId || 'default'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å®ä¾‹åˆ›å»ºæˆåŠŸ');
                    closeCreateInstanceModal();
                    loadInstances();
                    loadSystemStats();
                } else {
                    alert('å®ä¾‹åˆ›å»ºå¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('[DASHBOARD] - ERROR - åˆ›å»ºå®ä¾‹å¤±è´¥:', error);
                alert('åˆ›å»ºå®ä¾‹å¤±è´¥');
            });
        }

        // é”€æ¯å®ä¾‹
        function destroyInstance(instanceId) {
            if (!confirm('ç¡®å®šè¦é”€æ¯è¿™ä¸ªå®ä¾‹å—ï¼Ÿ')) return;
            
            console.log('[DASHBOARD] - INFO - é”€æ¯å®ä¾‹:', instanceId);
            
            fetch(`/api/instances/${instanceId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å®ä¾‹é”€æ¯æˆåŠŸ');
                    loadInstances();
                    loadSystemStats();
                } else {
                    alert('å®ä¾‹é”€æ¯å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('[DASHBOARD] - ERROR - é”€æ¯å®ä¾‹å¤±è´¥:', error);
                alert('é”€æ¯å®ä¾‹å¤±è´¥');
            });
        }

        // æ³¨é”€
        function logout() {
            if (!confirm('ç¡®å®šè¦æ³¨é”€å—ï¼Ÿ')) return;
            
            fetch('/api/logout', {
                method: 'POST'
            })
            .then(() => {
                window.location.href = '/login';
            })
            .catch(error => {
                console.error('[DASHBOARD] - ERROR - æ³¨é”€å¤±è´¥:', error);
                window.location.href = '/login';
            });
        }

        // ç”¨æˆ·èµ„æ–™ç®¡ç†åŠŸèƒ½
        function showCreateProfileModal() {
            document.getElementById('create-profile-modal').style.display = 'block';
        }

        function closeCreateProfileModal() {
            document.getElementById('create-profile-modal').style.display = 'none';
            document.getElementById('new-profile-name').value = '';
            document.getElementById('new-profile-description').value = '';
        }

        function confirmCreateProfile() {
            const profileName = document.getElementById('new-profile-name').value;
            const profileDescription = document.getElementById('new-profile-description').value;
            
            if (!profileName.trim()) {
                alert('è¯·è¾“å…¥èµ„æ–™åç§°');
                return;
            }
            
            console.log('[DASHBOARD] - INFO - åˆ›å»ºç”¨æˆ·èµ„æ–™:', profileName);
            
            // æ¨¡æ‹Ÿåˆ›å»ºç”¨æˆ·èµ„æ–™APIè°ƒç”¨
            setTimeout(() => {
                alert('ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ');
                closeCreateProfileModal();
                loadProfiles();
            }, 500);
        }

        function editProfile(profileId) {
            console.log('[DASHBOARD] - INFO - ç¼–è¾‘ç”¨æˆ·èµ„æ–™:', profileId);
            alert('ç¼–è¾‘åŠŸèƒ½å¾…å®ç°');
        }

        function deleteProfile(profileId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·èµ„æ–™å—ï¼Ÿ')) return;
            
            console.log('[DASHBOARD] - INFO - åˆ é™¤ç”¨æˆ·èµ„æ–™:', profileId);
            alert('ç”¨æˆ·èµ„æ–™åˆ é™¤æˆåŠŸ');
            loadProfiles();
        }

        // åˆ†ç»„ç®¡ç†åŠŸèƒ½
        function showCreateGroupModal() {
            document.getElementById('create-group-modal').style.display = 'block';
        }

        function closeCreateGroupModal() {
            document.getElementById('create-group-modal').style.display = 'none';
            document.getElementById('new-group-name').value = '';
            document.getElementById('new-group-description').value = '';
        }

        function confirmCreateGroup() {
            const groupName = document.getElementById('new-group-name').value;
            const groupDescription = document.getElementById('new-group-description').value;
            
            if (!groupName.trim()) {
                alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                return;
            }
            
            console.log('[DASHBOARD] - INFO - åˆ›å»ºåˆ†ç»„:', groupName);
            
            // æ¨¡æ‹Ÿåˆ›å»ºåˆ†ç»„APIè°ƒç”¨
            setTimeout(() => {
                alert('åˆ†ç»„åˆ›å»ºæˆåŠŸ');
                closeCreateGroupModal();
                loadGroups();
            }, 500);
        }

        function editGroup(groupId) {
            console.log('[DASHBOARD] - INFO - ç¼–è¾‘åˆ†ç»„:', groupId);
            alert('ç¼–è¾‘åŠŸèƒ½å¾…å®ç°');
        }

        function deleteGroup(groupId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç»„å—ï¼Ÿ')) return;
            
            console.log('[DASHBOARD] - INFO - åˆ é™¤åˆ†ç»„:', groupId);
            alert('åˆ†ç»„åˆ é™¤æˆåŠŸ');
            loadGroups();
        }

        // JavaScriptæ³¨å…¥åŠŸèƒ½
        function loadJsModule(moduleName) {
            console.log('[DASHBOARD] - INFO - åŠ è½½JSæ¨¡å—:', moduleName);
            
            // æ¨¡æ‹ŸåŠ è½½æ¨¡å—å†…å®¹
            const moduleContent = {
                'telegram_utils.js': 'console.log("Telegramå·¥å…·æ¨¡å—å·²åŠ è½½");',
                'message_sender.js': 'function sendMessage(text) { console.log("å‘é€æ¶ˆæ¯:", text); }',
                'contact_manager.js': 'function getContacts() { return []; }',
                'auto_reply.js': 'function setAutoReply(enabled) { console.log("è‡ªåŠ¨å›å¤:", enabled); }',
                'media_handler.js': 'function uploadMedia(file) { console.log("ä¸Šä¼ åª’ä½“:", file); }'
            };
            
            document.getElementById('js-code').value = moduleContent[moduleName] || '// æ¨¡å—å†…å®¹';
        }

        function executeJs() {
            const instanceId = document.getElementById('target-instance').value;
            const jsCode = document.getElementById('js-code').value;
            
            if (!instanceId) {
                alert('è¯·é€‰æ‹©ç›®æ ‡å®ä¾‹');
                return;
            }
            
            if (!jsCode.trim()) {
                alert('è¯·è¾“å…¥JavaScriptä»£ç ');
                return;
            }
            
            console.log('[DASHBOARD] - INFO - æ‰§è¡ŒJSæ³¨å…¥:', instanceId, jsCode);
            
            // æ¨¡æ‹ŸJSæ³¨å…¥APIè°ƒç”¨
            fetch(`/api/instances/${instanceId}/execute_js`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: jsCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('JavaScriptæ³¨å…¥æˆåŠŸ');
                } else {
                    alert('JavaScriptæ³¨å…¥å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('[DASHBOARD] - ERROR - JSæ³¨å…¥å¤±è´¥:', error);
                alert('JavaScriptæ³¨å…¥å¤±è´¥');
            });
        }
    </script>
</body>
</html>