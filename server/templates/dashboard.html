<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Bot管理系统</title>
    <style>
        /* 全局样式 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* 顶部状态栏 */
        .status-bar {
            background-color: #1e1e1e;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #333;
        }
        
        .status-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .status-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .system-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4caf50;
        }
        
        .status-text {
            font-size: 14px;
            color: #aaaaaa;
        }
        
        .status-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #4a6ed3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5ec3;
        }
        
        .btn-secondary {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        
        .btn-secondary:hover {
            background-color: #333333;
        }
        
        .btn-danger {
            background-color: #d32f2f;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c62828;
        }
        
        /* 主要内容网格 */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        /* 卡片样式 */
        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 500;
            color: #ffffff;
            margin: 0;
        }
        
        .card-action {
            padding: 4px 8px;
            background-color: #4a6ed3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .card-action:hover {
            background-color: #3a5ec3;
        }
        
        /* 统计项 */
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            background-color: #252525;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #333;
        }
        
        .stat-label {
            font-size: 13px;
            color: #aaaaaa;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .stat-value.success {
            color: #4caf50;
        }
        
        .stat-value.error {
            color: #f44336;
        }
        
        .stat-value.warning {
            color: #ff9800;
        }
        
        /* 实例列表、用户资料列表和分组列表 */
        .instance-list, .profile-list, .group-list {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .instance-item, .profile-item, .group-item {
            background-color: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .instance-info h4, .profile-info h4, .group-info h4 {
            margin: 0 0 4px 0;
            color: #ffffff;
            font-size: 13px;
        }
        
        .instance-info p, .profile-info p, .group-info p {
            margin: 0;
            font-size: 11px;
            color: #aaaaaa;
        }
        
        .instance-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .instance-actions, .profile-actions, .group-actions {
            display: flex;
            gap: 4px;
        }
        
        .instance-actions button, .profile-actions button, .group-actions button {
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        
        /* JS注入相关样式 */
        .js-injection-container {
            display: grid;
            gap: 15px;
        }
        
        .js-modules {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .js-module-btn {
            padding: 6px 12px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .js-module-btn:hover {
            background-color: #4a6ed3;
            border-color: #4a6ed3;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: #1e1e1e;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            margin: 0;
            color: #ffffff;
            font-size: 18px;
        }
        
        .close {
            color: #aaaaaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #ffffff;
        }
        
        /* 日志输出 */
        .log-output {
            background-color: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            color: #e0e0e0;
            height: 200px;
            overflow-y: auto;
        }
        
        .log-line {
            margin-bottom: 3px;
        }
        
        .log-timestamp {
            color: #666666;
            margin-right: 8px;
        }
        
        .log-level-info {
            color: #64b5f6;
        }
        
        .log-level-error {
            color: #e57373;
        }
        
        .log-level-warning {
            color: #ffb74d;
        }
        
        /* 配置表单 */
        .config-form {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-size: 13px;
            color: #aaaaaa;
        }
        
        .form-input {
            padding: 8px 12px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #ffffff;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4a6ed3;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        /* 加载状态 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666666;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #4a6ed3;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- 状态栏 -->
    <div class="status-bar">
        <div class="status-left">
            <div class="status-title">Telegram Bot管理系统</div>
            <div class="system-status">
                <div class="status-indicator" id="system-status-indicator"></div>
                <span class="status-text" id="system-status-text">系统运行正常</span>
            </div>
        </div>
        <div class="status-actions">
            <button class="btn btn-primary" id="create-instance-btn">创建实例</button>
            <button class="btn btn-secondary" id="refresh-btn">刷新</button>
            <button class="btn btn-danger" id="logout-btn">注销</button>
        </div>
    </div>

    <!-- 主要内容网格 -->
    <div class="content-grid">
        <!-- 系统统计 -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">系统统计</h3>
                <button class="card-action" onclick="loadSystemStats()">刷新</button>
            </div>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-label">总实例数</div>
                    <div class="stat-value" id="total-instances">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">活跃实例</div>
                    <div class="stat-value success" id="active-instances">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">错误实例</div>
                    <div class="stat-value error" id="error-instances">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">运行时间</div>
                    <div class="stat-value" id="system-uptime">-</div>
                </div>
            </div>
        </div>

        <!-- 用户资料管理 -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">用户资料</h3>
                <button class="card-action" onclick="showCreateProfileModal()">新建</button>
            </div>
            <div class="profile-list" id="profile-list">
                <div class="empty-state">
                    <div class="empty-state-icon">👤</div>
                    <p>暂无资料</p>
                </div>
            </div>
        </div>

        <!-- 分组管理 -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">分组管理</h3>
                <button class="card-action" onclick="showCreateGroupModal()">新建</button>
            </div>
            <div class="group-list" id="group-list">
                <div class="empty-state">
                    <div class="empty-state-icon">📁</div>
                    <p>暂无分组</p>
                </div>
            </div>
        </div>

        <!-- 实例列表 -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">实例列表</h3>
                <button class="card-action" onclick="loadInstances()">刷新</button>
            </div>
            <div class="instance-list" id="instance-list">
                <div class="empty-state">
                    <div class="empty-state-icon">📱</div>
                    <p>暂无实例</p>
                </div>
            </div>
        </div>

        <!-- JavaScript注入 -->
        <div class="card" style="grid-column: span 2;">
            <div class="card-header">
                <h3 class="card-title">JavaScript注入</h3>
                <button class="card-action" onclick="loadJsModules()">刷新</button>
            </div>
            <div class="js-injection-container">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">选择实例</label>
                        <select class="form-input" id="target-instance">
                            <option value="">请选择实例</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">预设模块</label>
                        <div class="js-modules" id="js-modules">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">JavaScript代码</label>
                    <textarea class="form-input" id="js-code" rows="6" placeholder="输入要注入的JavaScript代码..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="executeJs()">执行注入</button>
            </div>
        </div>
    </div>

    <!-- 创建实例模态框 -->
    <div id="create-instance-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">创建新实例</h3>
                <span class="close" onclick="closeCreateInstanceModal()">&times;</span>
            </div>
            <div class="config-form">
                <div class="form-group">
                    <label class="form-label">实例名称</label>
                    <input type="text" class="form-input" id="new-instance-name" placeholder="输入实例名称">
                </div>
                <div class="form-group">
                    <label class="form-label">选择用户资料</label>
                    <select class="form-input" id="new-instance-profile">
                        <option value="default">默认资料</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">选择分组</label>
                    <select class="form-input" id="new-instance-group">
                        <option value="default">默认分组</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="confirmCreateInstance()">确认创建</button>
                <button class="btn btn-secondary" onclick="closeCreateInstanceModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 创建用户资料模态框 -->
    <div id="create-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">创建用户资料</h3>
                <span class="close" onclick="closeCreateProfileModal()">&times;</span>
            </div>
            <div class="config-form">
                <div class="form-group">
                    <label class="form-label">资料名称</label>
                    <input type="text" class="form-input" id="new-profile-name" placeholder="输入资料名称">
                </div>
                <div class="form-group">
                    <label class="form-label">描述</label>
                    <textarea class="form-input" id="new-profile-description" rows="3" placeholder="输入资料描述"></textarea>
                </div>
                <button class="btn btn-primary" onclick="confirmCreateProfile()">确认创建</button>
                <button class="btn btn-secondary" onclick="closeCreateProfileModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 创建分组模态框 -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">创建分组</h3>
                <span class="close" onclick="closeCreateGroupModal()">&times;</span>
            </div>
            <div class="config-form">
                <div class="form-group">
                    <label class="form-label">分组名称</label>
                    <input type="text" class="form-input" id="new-group-name" placeholder="输入分组名称">
                </div>
                <div class="form-group">
                    <label class="form-label">分组描述</label>
                    <textarea class="form-input" id="new-group-description" rows="3" placeholder="输入分组描述"></textarea>
                </div>
                <button class="btn btn-primary" onclick="confirmCreateGroup()">确认创建</button>
                <button class="btn btn-secondary" onclick="closeCreateGroupModal()">取消</button>
            </div>
        </div>
    </div>

    <script>
        console.log('[DASHBOARD] - INFO - 仪表板页面脚本加载');

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[DASHBOARD] - INFO - 仪表板页面初始化');
            initializePage();
        });

        // 初始化页面
        function initializePage() {
            loadSystemStats();
            loadInstances();
            loadProfiles();
            loadGroups();
            loadJsModules();
            bindEvents();
            
            // 设置自动刷新
            setInterval(loadSystemStats, 30000);
            setInterval(loadInstances, 60000);
        }

        // 绑定事件
        function bindEvents() {
            // 创建实例按钮
            document.getElementById('create-instance-btn').addEventListener('click', showCreateInstanceModal);
            
            // 刷新按钮
            document.getElementById('refresh-btn').addEventListener('click', function() {
                loadSystemStats();
                loadInstances();
                loadProfiles();
                loadGroups();
                loadJsModules();
            });
            
            // 注销按钮
            document.getElementById('logout-btn').addEventListener('click', logout);
        }

        // 加载系统统计
        function loadSystemStats() {
            console.log('[DASHBOARD] - INFO - 加载系统统计');
            
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSystemStats(data.data);
                        updateSystemStatus('connected', '系统运行正常');
                    } else {
                        updateSystemStatus('error', '系统错误');
                    }
                })
                .catch(error => {
                    console.error('[DASHBOARD] - ERROR - 加载系统统计失败:', error);
                    updateSystemStatus('error', '连接失败');
                });
        }

        // 更新系统统计
        function updateSystemStats(stats) {
            document.getElementById('total-instances').textContent = stats.instances?.total || 0;
            document.getElementById('active-instances').textContent = stats.instances?.active || 0;
            document.getElementById('error-instances').textContent = stats.instances?.error || 0;
            
            if (stats.server?.uptime) {
                const hours = Math.floor(stats.server.uptime / 3600);
                const minutes = Math.floor((stats.server.uptime % 3600) / 60);
                document.getElementById('system-uptime').textContent = `${hours}小时${minutes}分钟`;
            }
        }

        // 更新系统状态
        function updateSystemStatus(status, text) {
            const indicator = document.getElementById('system-status-indicator');
            const statusText = document.getElementById('system-status-text');
            
            indicator.className = 'status-indicator';
            if (status === 'connected') {
                indicator.style.backgroundColor = '#4caf50';
            } else if (status === 'error') {
                indicator.style.backgroundColor = '#f44336';
            }
            
            statusText.textContent = text;
        }

        // 加载实例列表
        function loadInstances() {
            console.log('[DASHBOARD] - INFO - 加载实例列表');
            
            fetch('/api/instances')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateInstancesList(data.data);
                    }
                })
                .catch(error => {
                    console.error('[DASHBOARD] - ERROR - 加载实例列表失败:', error);
                });
        }

        // 更新实例列表
        function updateInstancesList(instances) {
            const container = document.getElementById('instance-list');
            const targetInstanceSelect = document.getElementById('target-instance');
            
            if (!instances || instances.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📱</div>
                        <p>暂无实例</p>
                    </div>
                `;
                targetInstanceSelect.innerHTML = '<option value="">请选择实例</option>';
                return;
            }
            
            // 更新实例列表显示
            container.innerHTML = instances.map(instance => `
                <div class="instance-item">
                    <div class="instance-info">
                        <h4>${instance.name || instance.id}</h4>
                        <p>资料: ${instance.profile_id || 'default'} | 创建: ${formatTime(instance.created_at)}</p>
                    </div>
                    <div class="instance-status ${getStatusClass(instance.status)}">
                        ${getStatusText(instance.status)}
                    </div>
                    <div class="instance-actions">
                        <button class="btn btn-danger" onclick="destroyInstance('${instance.id}')">销毁</button>
                    </div>
                </div>
            `).join('');
            
            // 更新JS注入的实例选择器
            targetInstanceSelect.innerHTML = '<option value="">请选择实例</option>' + 
                instances.map(instance => `
                    <option value="${instance.id}">${instance.name || instance.id}</option>
                `).join('');
        }

        // 加载用户资料列表
        function loadProfiles() {
            console.log('[DASHBOARD] - INFO - 加载用户资料列表');
            
            // 模拟获取用户资料数据
            setTimeout(() => {
                const profiles = [
                    { id: 'default', name: '默认资料', description: '系统默认用户资料', created_at: Date.now() / 1000 }
                ];
                updateProfilesList(profiles);
            }, 500);
        }

        // 更新用户资料列表
        function updateProfilesList(profiles) {
            const container = document.getElementById('profile-list');
            const profileSelect = document.getElementById('new-instance-profile');
            
            if (!profiles || profiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👤</div>
                        <p>暂无资料</p>
                    </div>
                `;
                return;
            }
            
            // 更新资料列表显示
            container.innerHTML = profiles.map(profile => `
                <div class="profile-item">
                    <div class="profile-info">
                        <h4>${profile.name}</h4>
                        <p>${profile.description || '暂无描述'}</p>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-secondary" onclick="editProfile('${profile.id}')">编辑</button>
                        ${profile.id !== 'default' ? `<button class="btn btn-danger" onclick="deleteProfile('${profile.id}')">删除</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            // 更新创建实例时的资料选择器
            profileSelect.innerHTML = profiles.map(profile => `
                <option value="${profile.id}">${profile.name}</option>
            `).join('');
        }

        // 加载分组列表
        function loadGroups() {
            console.log('[DASHBOARD] - INFO - 加载分组列表');
            
            // 模拟获取分组数据
            setTimeout(() => {
                const groups = [
                    { id: 'default', name: '默认分组', description: '系统默认分组', instance_count: 0, created_at: Date.now() / 1000 }
                ];
                updateGroupsList(groups);
            }, 500);
        }

        // 更新分组列表
        function updateGroupsList(groups) {
            const container = document.getElementById('group-list');
            const groupSelect = document.getElementById('new-instance-group');
            
            if (!groups || groups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📁</div>
                        <p>暂无分组</p>
                    </div>
                `;
                return;
            }
            
            // 更新分组列表显示
            container.innerHTML = groups.map(group => `
                <div class="group-item">
                    <div class="group-info">
                        <h4>${group.name}</h4>
                        <p>实例数: ${group.instance_count || 0} | ${group.description || '暂无描述'}</p>
                    </div>
                    <div class="group-actions">
                        <button class="btn btn-secondary" onclick="editGroup('${group.id}')">编辑</button>
                        ${group.id !== 'default' ? `<button class="btn btn-danger" onclick="deleteGroup('${group.id}')">删除</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            // 更新创建实例时的分组选择器
            groupSelect.innerHTML = groups.map(group => `
                <option value="${group.id}">${group.name}</option>
            `).join('');
        }

        // 加载JavaScript模块
        function loadJsModules() {
            console.log('[DASHBOARD] - INFO - 加载JavaScript模块');
            
            const container = document.getElementById('js-modules');
            
            // 模拟获取JS模块数据
            setTimeout(() => {
                const modules = [
                    'telegram_utils.js',
                    'message_sender.js',
                    'contact_manager.js',
                    'auto_reply.js',
                    'media_handler.js'
                ];
                
                container.innerHTML = modules.map(module => `
                    <button class="js-module-btn" onclick="loadJsModule('${module}')">${module}</button>
                `).join('');
            }, 800);
        }

        // 获取状态样式类
        function getStatusClass(status) {
            switch(status) {
                case 'ready': return 'success';
                case 'error': return 'error';
                case 'initializing': return 'warning';
                default: return '';
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            switch(status) {
                case 'ready': return '就绪';
                case 'error': return '错误';
                case 'initializing': return '初始化';
                case 'terminated': return '已终止';
                default: return status;
            }
        }

        // 格式化时间
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp * 1000).toLocaleString('zh-CN');
        }

        // 显示创建实例模态框
        function showCreateInstanceModal() {
            document.getElementById('create-instance-modal').style.display = 'block';
        }

        // 关闭创建实例模态框
        function closeCreateInstanceModal() {
            document.getElementById('create-instance-modal').style.display = 'none';
            document.getElementById('new-instance-name').value = '';
        }

        // 确认创建实例
        function confirmCreateInstance() {
            const instanceName = document.getElementById('new-instance-name').value;
            const profileId = document.getElementById('new-instance-profile').value;
            const groupId = document.getElementById('new-instance-group').value;
            
            if (!instanceName.trim()) {
                alert('请输入实例名称');
                return;
            }
            
            console.log('[DASHBOARD] - INFO - 创建实例:', instanceName);
            
            fetch('/api/instances', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: instanceName,
                    group_id: groupId || 'default',
                    profile_id: profileId || 'default'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('实例创建成功');
                    closeCreateInstanceModal();
                    loadInstances();
                    loadSystemStats();
                } else {
                    alert('实例创建失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('[DASHBOARD] - ERROR - 创建实例失败:', error);
                alert('创建实例失败');
            });
        }

        // 销毁实例
        function destroyInstance(instanceId) {
            if (!confirm('确定要销毁这个实例吗？')) return;
            
            console.log('[DASHBOARD] - INFO - 销毁实例:', instanceId);
            
            fetch(`/api/instances/${instanceId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('实例销毁成功');
                    loadInstances();
                    loadSystemStats();
                } else {
                    alert('实例销毁失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('[DASHBOARD] - ERROR - 销毁实例失败:', error);
                alert('销毁实例失败');
            });
        }

        // 注销
        function logout() {
            if (!confirm('确定要注销吗？')) return;
            
            fetch('/api/logout', {
                method: 'POST'
            })
            .then(() => {
                window.location.href = '/login';
            })
            .catch(error => {
                console.error('[DASHBOARD] - ERROR - 注销失败:', error);
                window.location.href = '/login';
            });
        }

        // 用户资料管理功能
        function showCreateProfileModal() {
            document.getElementById('create-profile-modal').style.display = 'block';
        }

        function closeCreateProfileModal() {
            document.getElementById('create-profile-modal').style.display = 'none';
            document.getElementById('new-profile-name').value = '';
            document.getElementById('new-profile-description').value = '';
        }

        function confirmCreateProfile() {
            const profileName = document.getElementById('new-profile-name').value;
            const profileDescription = document.getElementById('new-profile-description').value;
            
            if (!profileName.trim()) {
                alert('请输入资料名称');
                return;
            }
            
            console.log('[DASHBOARD] - INFO - 创建用户资料:', profileName);
            
            // 模拟创建用户资料API调用
            setTimeout(() => {
                alert('用户资料创建成功');
                closeCreateProfileModal();
                loadProfiles();
            }, 500);
        }

        function editProfile(profileId) {
            console.log('[DASHBOARD] - INFO - 编辑用户资料:', profileId);
            alert('编辑功能待实现');
        }

        function deleteProfile(profileId) {
            if (!confirm('确定要删除这个用户资料吗？')) return;
            
            console.log('[DASHBOARD] - INFO - 删除用户资料:', profileId);
            alert('用户资料删除成功');
            loadProfiles();
        }

        // 分组管理功能
        function showCreateGroupModal() {
            document.getElementById('create-group-modal').style.display = 'block';
        }

        function closeCreateGroupModal() {
            document.getElementById('create-group-modal').style.display = 'none';
            document.getElementById('new-group-name').value = '';
            document.getElementById('new-group-description').value = '';
        }

        function confirmCreateGroup() {
            const groupName = document.getElementById('new-group-name').value;
            const groupDescription = document.getElementById('new-group-description').value;
            
            if (!groupName.trim()) {
                alert('请输入分组名称');
                return;
            }
            
            console.log('[DASHBOARD] - INFO - 创建分组:', groupName);
            
            // 模拟创建分组API调用
            setTimeout(() => {
                alert('分组创建成功');
                closeCreateGroupModal();
                loadGroups();
            }, 500);
        }

        function editGroup(groupId) {
            console.log('[DASHBOARD] - INFO - 编辑分组:', groupId);
            alert('编辑功能待实现');
        }

        function deleteGroup(groupId) {
            if (!confirm('确定要删除这个分组吗？')) return;
            
            console.log('[DASHBOARD] - INFO - 删除分组:', groupId);
            alert('分组删除成功');
            loadGroups();
        }

        // JavaScript注入功能
        function loadJsModule(moduleName) {
            console.log('[DASHBOARD] - INFO - 加载JS模块:', moduleName);
            
            // 模拟加载模块内容
            const moduleContent = {
                'telegram_utils.js': 'console.log("Telegram工具模块已加载");',
                'message_sender.js': 'function sendMessage(text) { console.log("发送消息:", text); }',
                'contact_manager.js': 'function getContacts() { return []; }',
                'auto_reply.js': 'function setAutoReply(enabled) { console.log("自动回复:", enabled); }',
                'media_handler.js': 'function uploadMedia(file) { console.log("上传媒体:", file); }'
            };
            
            document.getElementById('js-code').value = moduleContent[moduleName] || '// 模块内容';
        }

        function executeJs() {
            const instanceId = document.getElementById('target-instance').value;
            const jsCode = document.getElementById('js-code').value;
            
            if (!instanceId) {
                alert('请选择目标实例');
                return;
            }
            
            if (!jsCode.trim()) {
                alert('请输入JavaScript代码');
                return;
            }
            
            console.log('[DASHBOARD] - INFO - 执行JS注入:', instanceId, jsCode);
            
            // 模拟JS注入API调用
            fetch(`/api/instances/${instanceId}/execute_js`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: jsCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('JavaScript注入成功');
                } else {
                    alert('JavaScript注入失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('[DASHBOARD] - ERROR - JS注入失败:', error);
                alert('JavaScript注入失败');
            });
        }
    </script>
</body>
</html>