{% extends "base.html" %}

{% set show_navbar = false %}

{% block title %}用户登录 - Telegram Bot管理系统{% endblock %}

{% block page_title %}用户登录{% endblock %}

{% block extra_css %}
<style>
/* 登录页面特殊样式 */
body {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

.header {
    display: none;
}

.container {
    max-width: 400px;
    padding: 0;
}

.login-container {
    background-color: #1e1e1e;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    padding: 30px;
}

.login-header {
    text-align: center;
    margin-bottom: 30px;
}

.login-header h1 {
    font-size: 24px;
    font-weight: 500;
    margin: 0;
    color: #ffffff;
}

.login-header p {
    margin-top: 8px;
    color: #aaaaaa;
    font-size: 14px;
}

.system-info {
    margin-top: 30px;
    text-align: center;
    font-size: 12px;
    color: #666666;
}
</style>
{% endblock %}

{% block content %}
<div class="login-container">
    <div class="login-header">
        <h1>Telegram自动化系统</h1>
        <p>管理员登录</p>
    </div>
    
    <!-- 错误消息显示区域 -->
    <div id="error-message" class="alert alert-error hidden"></div>
    
    <!-- 成功消息显示区域 -->
    <div id="success-message" class="alert alert-success hidden"></div>
    
    <!-- 登录表单 -->
    <form id="login-form">
        <div class="form-group">
            <label for="username" class="form-label">用户名</label>
            <input type="text" id="username" name="username" class="form-input" required autocomplete="username">
        </div>
        
        <div class="form-group">
            <label for="password" class="form-label">密码</label>
            <input type="password" id="password" name="password" class="form-input" required autocomplete="current-password">
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary" id="login-btn">
                <span id="login-text">登录系统</span>
                <span id="login-loading" class="loading hidden"></span>
            </button>
        </div>
    </form>
    
    <div class="system-info">
        Telegram自动化系统 &copy; 2023-2024<br>
        系统版本: v2.0 | 安全登录
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 登录表单处理
document.getElementById('login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const loginText = document.getElementById('login-text');
    const loginLoading = document.getElementById('login-loading');
    
    // 获取表单数据
    const username = usernameInput.value.trim();
    const password = passwordInput.value;
    
    // 验证输入
    if (!username || !password) {
        showAlert('请输入用户名和密码', 'error');
        return;
    }
    
    // 显示加载状态
    loginBtn.disabled = true;
    loginText.classList.add('hidden');
    loginLoading.classList.remove('hidden');
    
    try {
        // 发送登录请求
        const response = await apiRequest('/api/login', {
            method: 'POST',
            body: JSON.stringify({
                username: username,
                password: password
            })
        });
        
        if (response.success) {
            // 登录成功，跳转到仪表板
            showAlert('登录成功，正在跳转...', 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("dashboard") }}';
            }, 1000);
        } else {
            // 登录失败，显示错误消息
            showAlert(response.message || '登录失败', 'error');
        }
        
    } catch (error) {
        console.error('登录请求失败:', error);
        showAlert('网络连接失败，请检查网络后重试', 'error');
    } finally {
        // 恢复按钮状态
        loginBtn.disabled = false;
        loginText.classList.remove('hidden');
        loginLoading.classList.add('hidden');
    }
});

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 聚焦到用户名输入框
    document.getElementById('username').focus();
    
    // 检查是否已经登录
    checkLoginStatus();
});

// 检查登录状态
async function checkLoginStatus() {
    try {
        const response = await apiRequest('/api/verify-token');
        if (response.success) {
            // 已经登录，直接跳转到仪表板
            window.location.href = '{{ url_for("dashboard") }}';
        }
    } catch (error) {
        // 未登录或验证失败，保持在登录页面
        console.log('用户未登录');
    }
}
</script>
{% endblock %}